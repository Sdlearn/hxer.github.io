<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>openvpn - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#Docker">Docker</a>&nbsp;»&nbsp;openvpn</div>
</div>
<div class="clearfix"></div>
<div id="title">openvpn</div>
  <div id="content">
  <h2 id="_1">获取镜像</h2>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">pull</span> <span class="n">kylemanna</span><span class="o">/</span><span class="n">openvpn</span>
</pre></div>


<h2 id="quick-start">quick start</h2>
<div class="hlcode"><pre><span class="n">OVPN_DATA</span><span class="o">=</span><span class="s">&quot;ovpn-data&quot;</span>

<span class="cp"># 初始化ovpn_data容器，包含配置文件和证书</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">name</span> <span class="err">$</span><span class="n">OVPN_DATA</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">busybox</span>

<span class="cp">#</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">volumes</span><span class="o">-</span><span class="n">from</span> <span class="err">$</span><span class="n">OVPN_DATA</span> <span class="o">--</span><span class="n">rm</span> <span class="n">kylemanna</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">ovpn_genconfig</span> <span class="o">-</span><span class="n">u</span> <span class="n">udp</span><span class="o">:</span><span class="c1">//VPN.SERVERNAME.COM  #更改VPN.SERVERNAME.COM为你的ip或域名</span>

<span class="cp"># 生成EasyRSA PKI 证书授权中心</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">volumes</span><span class="o">-</span><span class="n">from</span> <span class="err">$</span><span class="n">OVPN_DATA</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="n">kylemanna</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">ovpn_initpki</span>

<span class="cp"># input ca pssword for securiry</span>
<span class="p">...</span>

<span class="cp">#sart openvpn server process</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">volumes</span><span class="o">-</span><span class="n">from</span> <span class="err">$</span><span class="n">OVPN_DATA</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">1194</span><span class="o">:</span><span class="mi">1194</span><span class="o">/</span><span class="n">udp</span> <span class="o">--</span><span class="n">cap</span><span class="o">-</span><span class="n">add</span><span class="o">=</span><span class="n">NET_ADMIN</span> <span class="n">kylemanna</span><span class="o">/</span><span class="n">openvpn</span>
</pre></div>


<ul>
<li>sh 文件配置</li>
</ul>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/bin/bash</span>
<span class="nb">set</span> -ex
<span class="nv">OVPN_DATA</span><span class="o">=</span>ovpn-data
<span class="nv">CLIENT</span><span class="o">=</span>xx-client
<span class="nv">IMG</span><span class="o">=</span>kylemanna/openvpn

<span class="c">#</span>
<span class="c"># Create a docker container with the config data</span>
<span class="c"># 初始化ovpn_data容器，包含配置文件和证书</span>
docker run --name <span class="nv">$OVPN_DATA</span> -v /etc/openvpn busybox

<span class="c"># fetch host ip</span>
ip addr ls
<span class="nv">SERV_IP</span><span class="o">=</span><span class="k">$(</span>ip -4 -o addr show scope global  | awk <span class="s1">&#39;{print $4}&#39;</span> | sed -e <span class="s1">&#39;s:/.*::&#39;</span> | head -n1<span class="k">)</span>


docker run --volumes-from <span class="nv">$OVPN_DATA</span> --rm <span class="nv">$IMG</span> ovpn_genconfig -u udp://<span class="nv">$SERV_IP</span>

<span class="c"># nopass is insecure</span>
docker run --volumes-from <span class="nv">$OVPN_DATA</span> --rm -it -e <span class="s2">&quot;EASYRSA_BATCH=1&quot;</span> -e <span class="s2">&quot;EASYRSA_REQ_CN=Travis-CI Test CA&quot;</span> <span class="nv">$IMG</span> ovpn_initpki nopass

docker run --volumes-from <span class="nv">$OVPN_DATA</span> --rm -it <span class="nv">$IMG</span> easyrsa build-client-full <span class="nv">$CLIENT</span> nopass

docker run --volumes-from <span class="nv">$OVPN_DATA</span> --rm <span class="nv">$IMG</span> ovpn_getclient <span class="nv">$CLIENT</span> &gt; <span class="nv">$CLIENT</span>.ovpn

<span class="c">#</span>
<span class="c"># Fire up the server</span>
<span class="c">#</span>
iptables -N DOCKER
ptables -I FORWARD -j DOCKER

<span class="c"># run in shell bg to get logs</span>
docker run --name <span class="s2">&quot;ovpn-test&quot;</span> --volumes-from <span class="nv">$OVPN_DATA</span> --rm -p 1194:1194/udp --privileged <span class="nv">$IMG</span>  1&gt;/root/ovpn_info.log 2&gt;/root/ovpn_error.log &amp;
</pre></div>
</td></tr></table>

<ul>
<li>生成客户端证书和配置文件</li>
</ul>
<p>替换CLIENTNAME, 客户端的名字是用来识别正在运行的OpenVPN客户端的机器, e.g. CLIENTNAME:phone</p>
<div class="hlcode"><pre><span class="cp"># 创建客户端证书</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">volumes</span><span class="o">-</span><span class="n">from</span> <span class="err">$</span><span class="n">OVPN_DATA</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="n">kylemanna</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">easyrsa</span> <span class="n">build</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">full</span> <span class="n">CLIENTNAME</span> <span class="n">nopass</span>

<span class="cp"># 传送到客户端证书和配置文件</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">volumes</span><span class="o">-</span><span class="n">from</span> <span class="err">$</span><span class="n">OVPN_DATA</span> <span class="o">--</span><span class="n">rm</span> <span class="n">kylemanna</span><span class="o">/</span><span class="n">openvpn</span> <span class="n">ovpn_getclient</span> <span class="n">CLIENTNAME</span> <span class="o">&gt;</span> <span class="n">CLIENTNAME</span><span class="p">.</span><span class="n">ovpn</span>
</pre></div>


<h2 id="openvpn">配置 openvpn 客户端</h2>
<p>在Ubuntu12.04/14.04和Debian wheezy/jessie客户端（或者类似的）：
安装OpenVPN：</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openvpn</span>
</pre></div>


<ul>
<li>命令行启动</li>
</ul>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">openvpn</span> <span class="n">CLIENTNAME</span><span class="p">.</span><span class="n">ovpn</span>
</pre></div>


<ul>
<li>OpenVPN Network Manager plugin</li>
</ul>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">network</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">openvpn</span><span class="o">-</span><span class="n">gnome</span>
</pre></div>


<p>then import .ovpn file</p>
<ul>
<li>note</li>
</ul>
<p>The OpenVPN protocol requires the client and server to have synchronized time. If the time on your local PC is incorrect you may see the error ##TLS Error: Unroutable control packet received## from in your logs</p>
<p>solve <a href="https://www.ivpn.net/knowledgebase/152/TLS-Error-Unroutable-control-packet-received.html">TLS Error: Unroutable control packet received</a></p>
<h2 id="_2">验证操作</h2>
<p>有几种通过VPN路由来验证网络连接的方法。</p>
<ul>
<li>网页浏览器</li>
</ul>
<p>访问网站来确定外部IP地址。外部IP地址应该是OpenVPN服务器。
试试google“what is my ip”或icanhazip.com。</p>
<ul>
<li>命令行</li>
</ul>
<p>从命令行，wget或curl命令派上用场。以curl为例：</p>
<div class="hlcode"><pre><span class="n">curl</span> <span class="n">icanhazip</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>以wget为例：</p>
<div class="hlcode"><pre><span class="n">wget</span> <span class="o">-</span><span class="n">qO</span> <span class="o">-</span> <span class="n">icanhazip</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>预期的反应应该是OpenVPN服务器的IP地址。</p>
<p>另一个选择是使用dig或使用host到一个特殊配置的DNS服务器做专用的DNS查询。基于host的例子：</p>
<div class="hlcode"><pre><span class="n">host</span> <span class="o">-</span><span class="n">t</span> <span class="n">A</span> <span class="n">myip</span><span class="p">.</span><span class="n">opendns</span><span class="p">.</span><span class="n">com</span> <span class="n">resolver1</span><span class="p">.</span><span class="n">opendns</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>基于dig的例子：</p>
<div class="hlcode"><pre><span class="n">dig</span> <span class="o">+</span><span class="kt">short</span> <span class="n">myip</span><span class="p">.</span><span class="n">opendns</span><span class="p">.</span><span class="n">com</span> <span class="err">@</span><span class="n">resolver1</span><span class="p">.</span><span class="n">opendns</span><span class="p">.</span><span class="n">com</span>
</pre></div>


<p>预期的反应应该是OpenVPN服务器的IP地址。</p>
<h2 id="_3">参考</h2>
<p><a href="http://dockone.io/article/214">在Ubuntu14.04的Docker容器中运行OpenVPN</a></p>
<p><a href="https://hub.docker.com/r/kylemanna/openvpn/">kylemanna/openvpn OpenVPN for Docker</a></p>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>