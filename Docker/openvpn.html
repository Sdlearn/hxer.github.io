<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>openvpn - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#Docker">Docker</a>&nbsp;»&nbsp;openvpn</div>
</div>
<div class="clearfix"></div>
<div id="title">openvpn</div>
  <div id="content">
  <h2 id="_1">获取镜像</h2>
<div class="hlcode"><pre>docker pull kylemanna/openvpn
</pre></div>


<h2 id="quick-start">quick start</h2>
<div class="hlcode"><pre><span class="x">OVPN_DATA=&quot;ovpn-data&quot;</span>

<span class="err">#</span><span class="x"> 初始化ovpn_data容器，包含配置文件和证书</span>
<span class="x">docker run --name </span><span class="p">$</span><span class="nv">OVPN_DATA</span><span class="x"> -v /etc/openvpn busybox</span>

<span class="err">#</span><span class="x"></span>
<span class="x">docker run --volumes-from </span><span class="p">$</span><span class="nv">OVPN_DATA</span><span class="x"> --rm kylemanna/openvpn ovpn_genconfig -u udp://VPN.SERVERNAME.COM  </span><span class="err">#</span><span class="x">更改VPN.SERVERNAME.COM为你的ip或域名</span>

<span class="err">#</span><span class="x"> 生成EasyRSA PKI 证书授权中心</span>
<span class="x">docker run --volumes-from </span><span class="p">$</span><span class="nv">OVPN_DATA</span><span class="x"> --rm -it kylemanna/openvpn ovpn_initpki</span>

<span class="err">#</span><span class="x"> input ca pssword for securiry</span>
<span class="x">...</span>

<span class="cp">#</span><span class="nf">sart</span><span class="x"> openvpn server process</span>
<span class="x">docker run --volumes-from </span><span class="p">$</span><span class="nv">OVPN_DATA</span><span class="x"> -d -p 1194:1194/udp --cap-add=NET_ADMIN kylemanna/openvpn</span>
</pre></div>


<ul>
<li>sh 文件配置</li>
</ul>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="hlcode"><pre><span class="ch">#!/bin/bash</span>
<span class="nb">set</span> -ex
<span class="nv">OVPN_DATA</span><span class="o">=</span>ovpn-data
<span class="nv">CLIENT</span><span class="o">=</span>xx-client
<span class="nv">IMG</span><span class="o">=</span>kylemanna/openvpn

<span class="c1">#</span>
<span class="c1"># Create a docker container with the config data</span>
<span class="c1"># 初始化ovpn_data容器，包含配置文件和证书</span>
docker run --name $OVPN_DATA -v /etc/openvpn busybox

<span class="c1"># fetch host ip</span>
ip addr ls
<span class="nv">SERV_IP</span><span class="o">=</span><span class="k">$(</span>ip -4 -o addr show scope global  <span class="p">|</span> awk <span class="s1">&#39;{print $4}&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s:/.*::&#39;</span> <span class="p">|</span> head -n1<span class="k">)</span>


docker run --volumes-from $OVPN_DATA --rm $IMG ovpn_genconfig -u udp://$SERV_IP

<span class="c1"># nopass is insecure</span>
docker run --volumes-from $OVPN_DATA --rm -it -e <span class="s2">&quot;EASYRSA_BATCH=1&quot;</span> -e <span class="s2">&quot;EASYRSA_REQ_CN=Travis-CI Test CA&quot;</span> $IMG ovpn_initpki nopass

docker run --volumes-from $OVPN_DATA --rm -it $IMG easyrsa build-client-full <span class="nv">$C</span>LIENT nopass

docker run --volumes-from $OVPN_DATA --rm $IMG ovpn_getclient <span class="nv">$C</span>LIENT &gt; <span class="nv">$C</span>LIENT.ovpn

<span class="c1">#</span>
<span class="c1"># Fire up the server</span>
<span class="c1">#</span>
iptables -N DOCKER
ptables -I FORWARD -j DOCKER

<span class="c1"># run in shell bg to get logs</span>
docker run --name <span class="s2">&quot;ovpn-server&quot;</span> --volumes-from $OVPN_DATA --rm -p 1194:1194/udp --privileged $IMG  1&gt;/root/ovpn_info.log 2&gt;/root/ovpn_error.log <span class="p">&amp;</span>
</pre></div>
</td></tr></table>

<ul>
<li>生成客户端证书和配置文件</li>
</ul>
<p>替换CLIENTNAME, 客户端的名字是用来识别正在运行的OpenVPN客户端的机器, e.g. CLIENTNAME:phone</p>
<div class="hlcode"><pre><span class="err">#</span><span class="x"> 创建客户端证书</span>
<span class="x">docker run --volumes-from </span><span class="p">$</span><span class="nv">OVPN_DATA</span><span class="x"> --rm -it kylemanna/openvpn easyrsa build-client-full CLIENTNAME nopass</span>

<span class="err">#</span><span class="x"> 传送到客户端证书和配置文件</span>
<span class="x">docker run --volumes-from </span><span class="p">$</span><span class="nv">OVPN_DATA</span><span class="x"> --rm kylemanna/openvpn ovpn_getclient CLIENTNAME &gt; CLIENTNAME.ovpn</span>
</pre></div>


<h2 id="openvpn">配置 openvpn 客户端</h2>
<p>在Ubuntu12.04/14.04和Debian wheezy/jessie客户端（或者类似的）：
安装OpenVPN：</p>
<div class="hlcode"><pre>sudo apt-get install openvpn
</pre></div>


<ul>
<li>命令行启动</li>
</ul>
<div class="hlcode"><pre>sudo openvpn CLIENTNAME.ovpn
</pre></div>


<ul>
<li>OpenVPN Network Manager plugin</li>
</ul>
<div class="hlcode"><pre>sudo apt-get install network-manager-openvpn-gnome
</pre></div>


<p>then import .ovpn file</p>
<ul>
<li>note</li>
</ul>
<p>The OpenVPN protocol requires the client and server to have synchronized time. If the time on your local PC is incorrect you may see the error ##TLS Error: Unroutable control packet received## from in your logs</p>
<p>solve <a href="https://www.ivpn.net/knowledgebase/152/TLS-Error-Unroutable-control-packet-received.html">TLS Error: Unroutable control packet received</a></p>
<h2 id="_2">验证操作</h2>
<p>有几种通过VPN路由来验证网络连接的方法。</p>
<ul>
<li>网页浏览器</li>
</ul>
<p>访问网站来确定外部IP地址。外部IP地址应该是OpenVPN服务器。
试试google“what is my ip”或icanhazip.com。</p>
<ul>
<li>命令行</li>
</ul>
<p>从命令行，wget或curl命令派上用场。以curl为例：</p>
<div class="hlcode"><pre>curl icanhazip.com
</pre></div>


<p>以wget为例：</p>
<div class="hlcode"><pre>wget -qO - icanhazip.com
</pre></div>


<p>预期的反应应该是OpenVPN服务器的IP地址。</p>
<p>另一个选择是使用dig或使用host到一个特殊配置的DNS服务器做专用的DNS查询。基于host的例子：</p>
<div class="hlcode"><pre>host -t A myip.opendns.com resolver1.opendns.com
</pre></div>


<p>基于dig的例子：</p>
<div class="hlcode"><pre>dig +short myip.opendns.com @resolver1.opendns.com
</pre></div>


<p>预期的反应应该是OpenVPN服务器的IP地址。</p>
<h2 id="_3">参考</h2>
<p><a href="http://dockone.io/article/214">在Ubuntu14.04的Docker容器中运行OpenVPN</a></p>
<p><a href="https://hub.docker.com/r/kylemanna/openvpn/">kylemanna/openvpn OpenVPN for Docker</a></p>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>