<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>Docker Compose - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#Docker">Docker</a>&nbsp;»&nbsp;Docker Compose</div>
</div>
<div class="clearfix"></div>
<div id="title">Docker Compose</div>
  <div id="content">
  <h2 id="_1">介绍</h2>
<p>Docker Compose 是官方提供的容器业务流程框架(曾经的项目名称是Fig)。</p>
<p>Docker Compose 处理Docker容器部署分布式应用，可以定义哪个容器运行哪个应用。</p>
<p>使用Compose，只需要定义一个多容器应用的yml文件(docker-compose.yml)，然后使用一条命令(docker-compose up)即可部署运行所有的容器。</p>
<h2 id="_2">安装</h2>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span>

<span class="cp"># 确认安装正确</span>
<span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">--</span><span class="n">version</span>
</pre></div>


<h2 id="_3">使用方法</h2>
<p>使用官网的简单示例</p>
<ul>
<li>准备</li>
</ul>
<div class="hlcode"><pre><span class="n">mkdir</span> <span class="n">compose_test</span>
<span class="n">cd</span> <span class="n">compose_test</span>
</pre></div>


<p>新建 app.py ，使用flash web框架，数据库使用redis</p>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">redis</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;redis&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="n">redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">&#39;hits&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;Hello, i have been seen {n} times&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;hits&#39;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>创建 requirements.txt</p>
<div class="hlcode"><pre><span class="n">flask</span>
<span class="n">redis</span>
</pre></div>


<ul>
<li>创建镜像</li>
</ul>
<p>Dockerfile创建镜像,</p>
<div class="hlcode"><pre><span class="n">FROM</span> <span class="n">python</span><span class="o">:</span><span class="mf">2.7</span>
<span class="n">ADD</span> <span class="p">.</span> <span class="o">/</span><span class="n">code</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<ul>
<li>定义服务</li>
</ul>
<p>创建docker-compose.yml</p>
<div class="hlcode"><pre><span class="n">web</span><span class="o">:</span>
    <span class="n">build</span><span class="o">:</span> <span class="o">.</span>
    <span class="n">command</span><span class="o">:</span> <span class="n">python</span> <span class="n">app</span><span class="o">.</span><span class="na">py</span>
    <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="s2">&quot;5000:5000&quot;</span>
    <span class="n">volumes</span><span class="o">:</span>
        <span class="o">-</span> <span class="o">.:/</span><span class="n">code</span>
    <span class="n">links</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">redis</span>

<span class="n">redis</span><span class="o">:</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">redis</span>
</pre></div>


<ul>
<li>
<p>web服务：该容器从当前文件夹的dockerfile创建，并运行 python app.py 命令; 将web容器内端口映射到主机5000端口;挂载当前文件夹到容器内部的/code文件夹，将web容器与redis容器连接</p>
</li>
<li>
<p>redis服务：直接由官方的redis镜像创建</p>
</li>
<li>
<p>启动</p>
</li>
</ul>
<div class="hlcode"><pre><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span>
</pre></div>


<p>先启动redis容器，再启动web容器，然后两者连接起来</p>
<ul>
<li>访问</li>
</ul>
<p>firefox &gt; 127.0.0.1:5000</p>
<div class="hlcode"><pre><span class="n">curl</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">5000</span>
</pre></div>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>