<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>进(线程)程处理 - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#Python">Python</a>&nbsp;»&nbsp;进(线程)程处理</div>
</div>
<div class="clearfix"></div>
<div id="title">进(线程)程处理</div>
  <div id="content">
  <h2 id="0x00">0x00 介绍</h2>
<p><a href="http://blog.rainy.im/2016/04/07/python-thread-and-coroutine/">python 线程与协程</a></p>
<p>并行: 简单来说并行就是我们现实世界运行的样子，每个人都是独立的执行单元，各自完成自己的任务，这对应着计算机中的分布式（多台计算机）或多核（多个CPU）运作模式</p>
<p>并发: 并发对应计算机中充分利用单核（一个CPU）实现（看起来）多个任务同时执行</p>
<p>一般来说，CPU密集型选用多进程，IO密集型选用多线程</p>
<div class="hlcode"><pre><span class="mh">0x01</span> <span class="n">parallel</span> <span class="n">python</span>
<span class="mh">0x02</span> <span class="n">multiprocessing</span>
<span class="mh">0x03</span> <span class="n">threading</span>
</pre></div>


<h2 id="0x01-parallel">0x01 parallel</h2>
<blockquote>
<p>version: py 2,3</p>
</blockquote>
<p><a href="http://www.parallelpython.com/">parallel 官网</a></p>
<p><a href="http://www.parallelpython.com/content/view/17/31/">parallel demo</a></p>
<p>Parallel Python 提供了 python 并发执行的机制，支持 SMP(systems with multiple processors or cores) 和 网络集群系统 (clusters)</p>
<h3 id="install">install</h3>
<ol>
<li>
<p><a href="http://www.parallelpython.com/">parallel 官网</a> download and install</p>
</li>
<li>
<p><code>pip install pp</code></p>
</li>
</ol>
<h3 id="module">module</h3>
<p>Server</p>
<div class="hlcode"><pre><span class="nx">__init__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">ncpus</span><span class="o">=</span><span class="s1">&#39;autodetect&#39;</span><span class="p">,</span> <span class="nx">ppservers</span><span class="o">=</span><span class="p">(),</span> <span class="nx">secret</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">restart</span><span class="o">=</span><span class="nx">False</span><span class="p">,</span> <span class="nx">proto</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nx">socket_timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>

<span class="nx">submit</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">args</span><span class="o">=</span><span class="p">(),</span> <span class="nx">depfuncs</span><span class="o">=</span><span class="p">(),</span> <span class="nx">modules</span><span class="o">=</span><span class="p">(),</span> <span class="nx">callback</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">callbackargs</span><span class="o">=</span><span class="p">(),</span> <span class="nx">group</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="nx">globals</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span>
    <span class="nx">Submits</span> <span class="kd">function</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">execution</span> <span class="nx">queue</span>

    <span class="nx">func</span> <span class="o">-</span> <span class="kd">function</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">executed</span>
    <span class="nx">args</span> <span class="o">-</span> <span class="nx">tuple</span> <span class="kd">with</span> <span class="nx">arguments</span> <span class="nx">of</span> <span class="nx">the</span> <span class="s1">&#39;func&#39;</span>
    <span class="nx">depfuncs</span> <span class="o">-</span> <span class="nx">tuple</span> <span class="kd">with</span> <span class="nx">functions</span> <span class="nx">which</span> <span class="nx">might</span> <span class="nx">be</span> <span class="nx">called</span> <span class="nx">from</span> <span class="s1">&#39;func&#39;</span>
    <span class="nx">modules</span> <span class="o">-</span> <span class="nx">tuple</span> <span class="kd">with</span> <span class="nx">module</span> <span class="nx">names</span> <span class="nx">to</span> <span class="kr">import</span>
    <span class="nx">callback</span> <span class="o">-</span> <span class="nx">callback</span> <span class="kd">function</span> <span class="nx">which</span> <span class="nx">will</span> <span class="nx">be</span> <span class="nx">called</span> <span class="kd">with</span> <span class="nx">argument</span> 
            <span class="nx">list</span> <span class="nx">equal</span> <span class="nx">to</span> <span class="nx">callbackargs</span><span class="o">+</span><span class="p">(</span><span class="nx">result</span><span class="p">,)</span> 
            <span class="nx">as</span> <span class="nx">soon</span> <span class="nx">as</span> <span class="nx">calculation</span> <span class="nx">is</span> <span class="nx">done</span>
    <span class="nx">callbackargs</span> <span class="o">-</span> <span class="nx">additional</span> <span class="nx">arguments</span> <span class="k">for</span> <span class="nx">callback</span> <span class="kd">function</span>
    <span class="nx">group</span> <span class="o">-</span> <span class="nx">job</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">is</span> <span class="nx">used</span> <span class="nx">when</span> <span class="nx">wait</span><span class="p">(</span><span class="nx">group</span><span class="p">)</span> <span class="nx">is</span> <span class="nx">called</span> <span class="nx">to</span> <span class="nx">wait</span> <span class="k">for</span>
    <span class="nx">jobs</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">given</span> <span class="nx">group</span> <span class="nx">to</span> <span class="nx">finish</span>
    <span class="nx">globals</span> <span class="o">-</span> <span class="nx">dictionary</span> <span class="nx">from</span> <span class="nx">which</span> <span class="nx">all</span> <span class="nx">modules</span><span class="p">,</span> <span class="nx">functions</span> <span class="nx">and</span> <span class="nx">classes</span>
    <span class="nx">will</span> <span class="nx">be</span> <span class="nx">imported</span><span class="p">,</span> <span class="k">for</span> <span class="nx">instance</span><span class="o">:</span> <span class="nx">globals</span><span class="o">=</span><span class="nx">globals</span><span class="p">()</span>
</pre></div>


<h3 id="guide">guide</h3>
<p>SMP</p>
<div class="hlcode"><pre><span class="mi">1</span><span class="p">)</span> <span class="n">Import</span> <span class="n">pp</span> <span class="n">module</span><span class="o">:</span>

    <span class="n">import</span> <span class="n">pp</span>

<span class="mi">2</span><span class="p">)</span> <span class="n">Start</span> <span class="n">pp</span> <span class="n">execution</span> <span class="n">server</span> <span class="n">with</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">workers</span> <span class="n">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">processors</span> <span class="n">in</span> <span class="n">the</span> <span class="n">system</span>

    <span class="n">job_server</span> <span class="o">=</span> <span class="n">pp</span><span class="p">.</span><span class="n">Server</span><span class="p">()</span> 

<span class="mi">3</span><span class="p">)</span> <span class="n">Submit</span> <span class="n">all</span> <span class="n">the</span> <span class="n">tasks</span> <span class="k">for</span> <span class="n">parallel</span> <span class="n">execution</span><span class="o">:</span>

    <span class="n">f1</span> <span class="o">=</span> <span class="n">job_server</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">func1</span><span class="p">,</span> <span class="n">args1</span><span class="p">,</span> <span class="n">depfuncs1</span><span class="p">,</span> <span class="n">modules1</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">job_server</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">func1</span><span class="p">,</span> <span class="n">args2</span><span class="p">,</span> <span class="n">depfuncs1</span><span class="p">,</span> <span class="n">modules1</span><span class="p">)</span>
    <span class="n">f3</span> <span class="o">=</span> <span class="n">job_server</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">func2</span><span class="p">,</span> <span class="n">args3</span><span class="p">,</span> <span class="n">depfuncs2</span><span class="p">,</span> <span class="n">modules2</span><span class="p">)</span> 
   <span class="p">...</span><span class="n">etc</span><span class="p">...</span>

<span class="mi">4</span><span class="p">)</span> <span class="n">Retrieve</span> <span class="n">the</span> <span class="n">results</span> <span class="n">as</span> <span class="n">needed</span><span class="o">:</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">f1</span><span class="p">()</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">f2</span><span class="p">()</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="n">f3</span><span class="p">()</span>
</pre></div>


<h2 id="0x02-multiprocessing">0x02 multiprocessing</h2>
<blockquote>
<p>标准库</p>
</blockquote>
<p>python 多进程管理</p>
<p><a href="https://docs.python.org/2/library/multiprocessing.html">document</a></p>
<h3 id="_1">常用类</h3>
<div class="hlcode"><pre><span class="kr">class</span> <span class="nx">multiprocessing</span><span class="p">.</span><span class="nx">Process</span><span class="p">(</span><span class="nx">group</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">target</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">name</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">args</span><span class="o">=</span><span class="p">(),</span> <span class="nx">kwargs</span><span class="o">=</span><span class="p">{})</span>

<span class="kr">class</span> <span class="nx">multiprocessing</span><span class="p">.</span><span class="nx">Pool</span><span class="p">(</span><span class="cp">[</span><span class="nx">processes</span><span class="err">[</span><span class="p">,</span> <span class="nx">initializer</span><span class="err">[</span><span class="p">,</span> <span class="nx">initargs</span><span class="err">[</span><span class="p">,</span> <span class="nx">maxtasksperchild</span><span class="cp">]</span><span class="p">]]])</span>
<span class="err">#</span> <span class="nx">functions</span>
<span class="nx">apply_async</span><span class="p">(</span><span class="nx">func</span><span class="cp">[</span><span class="p">,</span> <span class="nx">args</span><span class="err">[</span><span class="p">,</span> <span class="nx">kwds</span><span class="err">[</span><span class="p">,</span> <span class="nx">callback</span><span class="cp">]</span><span class="p">]])</span>   <span class="err">非阻塞</span>
<span class="nx">apply</span><span class="p">(</span><span class="nx">func</span><span class="cp">[</span><span class="p">,</span> <span class="nx">args</span><span class="err">[</span><span class="p">,</span> <span class="nx">kwds</span><span class="cp">]</span><span class="p">])</span>     <span class="err">阻塞</span>
<span class="nx">map_async</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">iterable</span><span class="cp">[</span><span class="p">,</span> <span class="nx">chunksize</span><span class="err">[</span><span class="p">,</span> <span class="nx">callback</span><span class="cp">]</span><span class="p">])</span>
<span class="nx">map</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">iterable</span><span class="cp">[</span><span class="p">,</span> <span class="nx">chunksize</span><span class="cp">]</span><span class="p">)</span>    <span class="k">return</span> <span class="nx">list</span>
<span class="nx">close</span><span class="p">()</span>        <span class="err">关闭</span><span class="nx">pool</span><span class="err">，使其不在接受新的任务。</span>
<span class="nx">terminate</span><span class="p">()</span>    <span class="err">结束工作进程，不在处理未完成的任务。</span>
<span class="nx">join</span><span class="p">()</span>         <span class="err">主进程阻塞，等待子进程的退出，</span> <span class="nx">join</span><span class="err">方法要在</span><span class="nx">close</span><span class="err">或</span><span class="nx">terminate</span><span class="err">之后使用</span>

<span class="kr">class</span> <span class="nx">multiprocessing</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">AsyncResult</span>
    <span class="nx">The</span> <span class="kr">class</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">result</span> <span class="nx">returned</span> <span class="nx">by</span> <span class="nx">Pool</span><span class="p">.</span><span class="nx">apply_async</span><span class="p">()</span> <span class="nx">and</span> <span class="nx">Pool</span><span class="p">.</span><span class="nx">map_async</span><span class="p">()</span>
<span class="err">#</span> <span class="nx">functions</span>
<span class="nx">get</span><span class="p">(</span><span class="cp">[</span><span class="nx">timeout</span><span class="cp">]</span><span class="p">)</span>  <span class="nx">Return</span> <span class="nx">the</span> <span class="nx">result</span> <span class="nx">when</span> <span class="nx">it</span> <span class="nx">arrives</span>
<span class="nx">wait</span><span class="p">(</span><span class="cp">[</span><span class="nx">timeout</span><span class="cp">]</span><span class="p">)</span> <span class="nx">Wait</span> <span class="nx">until</span> <span class="nx">the</span> <span class="nx">result</span> <span class="nx">is</span> <span class="nx">available</span> <span class="nx">or</span> <span class="nx">until</span> <span class="nx">timeout</span> <span class="nx">seconds</span> <span class="nx">pass</span><span class="p">.</span>
<span class="nx">ready</span><span class="p">()</span>         <span class="nx">Return</span> <span class="nx">whether</span> <span class="nx">the</span> <span class="nx">call</span> <span class="nx">has</span> <span class="nx">completed</span>
<span class="nx">successful</span><span class="p">()</span>    <span class="nx">Return</span> <span class="nx">whether</span> <span class="nx">the</span> <span class="nx">call</span> <span class="nx">completed</span> <span class="nx">without</span> <span class="nx">raising</span> <span class="nx">an</span> <span class="nx">exception</span>
</pre></div>


<p><strong> Pool: </strong> 启动大量的子进程，可以用进程池的方式批量创建子进程：</p>
<ul>
<li>
<p>demo</p>
</li>
<li>
<p>Process</p>
</li>
</ul>
<div class="hlcode"><pre>
</pre></div>


<ol>
<li>Pool</li>
</ol>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">worker</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span><span class="o">:</span>
    <span class="n">print</span> <span class="n">arg1</span>
    <span class="k">return</span> <span class="n">arg1</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;hello %d&quot;</span> <span class="o">%</span><span class="n">i</span>
    <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="p">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)))</span>

<span class="n">pool</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">for</span> <span class="n">r</span> <span class="n">in</span> <span class="n">result</span><span class="o">:</span>
    <span class="n">print</span> <span class="n">r</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>

<span class="cp">#     </span>
<span class="n">multiple_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="p">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
<span class="n">print</span> <span class="p">[</span><span class="n">res</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="n">in</span> <span class="n">multiple_results</span><span class="p">]</span>

<span class="cp">#</span>
<span class="n">print</span> <span class="n">pool</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> 
</pre></div>


<h3 id="multiprocessingdummy"><strong> multiprocessing.dummy </strong></h3>
<p>dummy 作用于线程</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">pool</span> <span class="n">import</span> <span class="n">ThreadPool</span>
</pre></div>


<h3 id="_2">备注</h3>
<p>在UNIX平台上，当某个进程终结之后，该进程需要被其父进程调用wait，否则进程成为僵尸进程(Zombie)， 所以，有必要对每个Process对象调用join()方法 (实际上等同于wait)。对于多线程来说，由于只有一个进程，所以不存在此必要性。</p>
<p>multiprocessing提供了threading包中没有的IPC(比如Pipe和Queue)，效率上更高。应优先考虑Pipe和Queue，避免使用Lock/Event/Semaphore/Condition等同步方式 (因为它们占据的不是用户进程的资源)。</p>
<p>多进程应该避免共享资源。在多线程中，我们可以比较容易地共享资源，比如使用全局变量或者传递参数。在多进程情况下，由于每个进程有自己独立的内存空间，以上方法并不合适。此时我们可以通过共享内存和Manager的方法来共享资源。但这样做提高了程序的复杂度，并因为同步的需要而降低了程序的效率</p>
<h2 id="0x03-threading">0x03 threading</h2>
<blockquote>
<p>标准库</p>
</blockquote>
<p><a href="https://docs.python.org/2/library/threading.html">document</a></p>
<h3 id="_3">常用类</h3>
<div class="hlcode"><pre><span class="n">class</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>