<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>Flask github api login - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#Python">Python</a>&nbsp;»&nbsp;Flask github api login</div>
</div>
<div class="clearfix"></div>
<div id="title">Flask github api login</div>
  <div id="content">
  <p>Flask框架中，使用Github api作第三方登录</p>
<h2 id="github">github 注册应用</h2>
<p><a href="https://help.github.com/articles/connecting-with-third-party-applications/">github connect with third party applications</a>
<a href="https://developer.github.com/v3/oauth/">github api</a></p>
<ul>
<li>注册应用</li>
</ul>
<p><a href="https://github.com/settings/applications/new">https://github.com/settings/applications/new</a>注册应用程序</p>
<div class="hlcode"><pre><span class="n">Application</span> <span class="n">name</span>
<span class="n">demo</span>

<span class="n">Homepage</span> <span class="n">URL</span>
<span class="nl">http:</span><span class="c1">//localhost:5000/github</span>


<span class="n">Application</span> <span class="n">description</span>
<span class="n">use</span> <span class="n">github</span> <span class="n">api</span> <span class="n">to</span> <span class="n">login</span>

<span class="n">Authorization</span> <span class="n">callback</span> <span class="n">URL</span>
<span class="nl">http:</span><span class="c1">//localhost:5000/github/callback</span>
</pre></div>


<p>Homepage URL 和 Authorization callback URL 根据需求来填，没有严格限制。注册完应用后会生成一个 Client ID 和 Client Secret, 这两个值用来访问Github API.它们应该存储在环境变量中，而不是被硬编码或放在版本控制库中，这样做是不安全的。</p>
<h2 id="dithubcode">重定向用户请求到dithub，获取code信息</h2>
<p>向 https://github.com/login/oauth/authorize 发送 get 请求，获取code信息。get请求需要带如下参数：</p>
<ul>
<li>client_id [required]</li>
</ul>
<p>注册应用获取的Client ID</p>
<ul>
<li>redirect_url [optional]</li>
</ul>
<p>从github获取code码之后跳转到的url, </p>
<p>The redirect_uri parameter is optional. If left out, GitHub will redirect users to the callback URL configured in the OAuth Application settings. If provided, the redirect URL's host and port must exactly match the callback URL. The redirect URL's path must reference a subdirectory of the callback URL.</p>
<div class="hlcode"><pre><span class="n">CALLBACK</span><span class="o">:</span> <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">path</span>

<span class="n">GOOD</span><span class="o">:</span> <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">path</span>
<span class="n">GOOD</span><span class="o">:</span> <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="sr">/path/subdir/</span><span class="n">other</span>
<span class="n">BAD</span><span class="o">:</span>  <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">bar</span>
<span class="n">BAD</span><span class="o">:</span>  <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">/</span>
<span class="n">BAD</span><span class="o">:</span>  <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">path</span>
<span class="n">BAD</span><span class="o">:</span>  <span class="n">http</span><span class="o">://</span><span class="n">oauth</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">path</span>
<span class="n">BAD</span><span class="o">:</span>  <span class="n">http</span><span class="o">://</span><span class="n">example</span><span class="o">.</span><span class="na">org</span>
</pre></div>


<ul>
<li>scope [optional]</li>
</ul>
<p>scope 返回你需要调用github哪些信息，可以填写多个，逗号分割，如: scope=user,public_repo</p>
<p>不填写就只读取github公开信息。</p>
<ul>
<li>state [oprional]</li>
</ul>
<p>state 自由设定，用于防止跨站请求伪造攻击</p>
<p>样例:</p>
<div class="hlcode"><pre><span class="cp"># 访问url</span>
<span class="nl">https:</span><span class="c1">//github.com/login/oauth/authorize?client_id=da43827a6b636a68e5ad</span>

<span class="cp"># github 返回code</span>
<span class="nl">http:</span><span class="c1">//loacalhost:5000/github/callback?code=8befa63003cbd59b56eb</span>
</pre></div>


<h2 id="codeaccess_token">通过code获取access_token</h2>
<p>获取access_token，需要向 https://github.com/login/oauth/access_token POST请求，参数如下：</p>
<ul>
<li>client_id [Required]</li>
</ul>
<p>The client ID you received from GitHub when you registered.</p>
<ul>
<li>client_secret [Required]</li>
</ul>
<p>The client secret you received from GitHub when you registered.</p>
<ul>
<li>code [Required]</li>
</ul>
<p>The code you received as a response</p>
<ul>
<li>redirect_uri  </li>
</ul>
<p>The URL in your app where users will be sent after authorization</p>
<ul>
<li>state </li>
</ul>
<p>The unguessable random string you optionally provided </p>
<div class="hlcode"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/github/callback&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">github_callback</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://github.com/login/oauth/access_token&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;client_secret&#39;</span><span class="p">:</span> <span class="n">client</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
            <span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span>
        <span class="p">}</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>

<span class="c"># github 返回参数</span>
<span class="n">access_token</span><span class="o">=</span><span class="mi">18365</span><span class="n">f14ea0b85beecf17e841af0060e493150d1</span><span class="o">&amp;</span><span class="n">scope</span><span class="o">=&amp;</span><span class="n">token_type</span><span class="o">=</span><span class="n">bearer</span>
</pre></div>


<h2 id="_1">获取用户登录信息</h2>
<p>向 https://api.github.com/user?access_token=xxx 发送GET请求，即可获得github信息</p>
<div class="hlcode"><pre><span class="n">public_repos</span><span class="o">:</span> <span class="mi">35</span>
<span class="n">site_admin</span><span class="o">:</span> <span class="n">False</span>
<span class="n">subscriptions_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/s</span><span class="n">ubscriptions</span>
<span class="n">gravatar_id</span><span class="o">:</span>
<span class="n">hireable</span><span class="o">:</span> <span class="n">None</span>
<span class="n">id</span><span class="o">:</span> <span class="mi">15061633</span>
<span class="n">followers_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/</span><span class="n">followers</span>
<span class="n">following_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/following{/</span><span class="n">other_user</span><span class="o">}</span>
<span class="n">blog</span><span class="o">:</span> <span class="n">None</span>
<span class="n">followers</span><span class="o">:</span> <span class="mi">0</span>
<span class="n">location</span><span class="o">:</span> <span class="n">None</span>
<span class="n">type</span><span class="o">:</span> <span class="n">User</span>
<span class="n">email</span><span class="o">:</span> <span class="n">None</span>
<span class="n">bio</span><span class="o">:</span> <span class="n">None</span>
<span class="n">gists_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/gists{/gis</span><span class="n">t_id</span><span class="o">}</span>
<span class="n">company</span><span class="o">:</span> <span class="n">None</span>
<span class="n">events_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/events{/</span><span class="n">privacy</span><span class="o">}</span>
<span class="n">html_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">hxer</span>
<span class="n">updated_at</span><span class="o">:</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span><span class="n">T01</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span><span class="mi">41</span><span class="n">Z</span>
<span class="n">received_events_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/</span><span class="n">received_events</span>
<span class="n">starred_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/starred{/owner}{/</span><span class="n">repo</span><span class="o">}</span>
<span class="n">public_gists</span><span class="o">:</span> <span class="mi">6</span>
<span class="n">name</span><span class="o">:</span> <span class="o">{{</span><span class="n">app</span><span class="o">.</span><span class="na">__dict__</span><span class="o">}}</span>
<span class="n">organizations_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/</span><span class="n">orgs</span>
<span class="n">url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/</span><span class="n">hxer</span>
<span class="n">created_at</span><span class="o">:</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">10</span><span class="n">T08</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mi">08</span><span class="n">Z</span>
<span class="n">avatar_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">avatars</span><span class="o">.</span><span class="na">githubusercontent</span><span class="o">.</span><span class="na">com</span><span class="sr">/u/</span><span class="mi">15061633</span><span class="o">?</span><span class="n">v</span><span class="o">=</span><span class="mi">3</span>
<span class="n">repos_url</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">api</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">com</span><span class="sr">/users/hxer/</span><span class="n">repos</span>
<span class="n">following</span><span class="o">:</span> <span class="mi">0</span>
<span class="n">login</span><span class="o">:</span> <span class="n">hxer</span>
</pre></div>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>