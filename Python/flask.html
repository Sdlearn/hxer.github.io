<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>Flask - Wiki | janes</title>
        <meta name="keywords" content=""/>
        <meta name="description" content=""/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/">Home</a>&nbsp;»&nbsp;<a href="/#Python">Python</a>&nbsp;»&nbsp;Flask</div>
</div>
<div class="clearfix"></div>
<div id="title">Flask</div>
  <div id="content">
  <h2 id="_1">参考资源</h2>
<ul>
<li><a href="http://www.wklken.me/posts/2013/09/09/python-framework-flask.html">FLASK使用小结</a></li>
<li><a href="http://flask.pocoo.org/docs/0.10/api/">flask api</a></li>
</ul>
<h2 id="_2">快速入门</h2>
<p>Flask依赖两个外部组件：Jinja2 和 Werkzeug路由模块</p>
<ul>
<li>变量规则</li>
</ul>
<p>给URL添加变量部分，可以将特殊的字段标记为&lt; variable_name &gt;,这个部分将会作为命名参数传递到你的函数。规则可以用 &lt; converter:variable_name &gt; 指定一个可选的转换器</p>
<div class="hlcode"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;username&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_user_profile</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="c"># show the user profile for that user</span>
    <span class="k">return</span> <span class="s">&#39;User </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">username</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/post/&lt;int:post_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="c"># show the post with the given id, the id is an integer</span>
    <span class="k">return</span> <span class="s">&#39;Post </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">post_id</span>
</pre></div>


<p>转换器有下面几种：</p>
<div class="hlcode"><pre><span class="kt">int</span>     <span class="err">接受整数</span>
<span class="kt">float</span>   <span class="err">同</span> <span class="kt">int</span> <span class="err">，但是接受浮点数</span>
<span class="n">path</span>    <span class="err">和默认的相似，但也接受斜线</span>
</pre></div>


<p>注:</p>
<blockquote>
<p>variable_name 不能为空，否则会报错，只输入一个或多个空格是支持的</p>
<p>函数参数variable_name默认参数无效，总是从url读取。</p>
<p>需要支持url variable_name 为空，和参数 variable_name有默认参数，可以参考如下方式</p>
</blockquote>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;hello&#39;</span><span class="o">+</span> <span class="p">(</span><span class="nb">name</span> <span class="k">if</span> <span class="nb">name</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
</pre></div>


<p>其中，默认参数可以随便设定，没必要必须是None</p>
<ul>
<li>url_for</li>
</ul>
<p>返回的是相对路径</p>
<p>URL 构建会转义特殊字符和 Unicode 数据</p>
<h2 id="_3">静态文件</h2>
<p>在你的包中或是模块的所在目录中创建一个名为 static 的文件夹，在应用中使用 /static 即可访问。</p>
<p>给静态文件生成 URL ，使用特殊的 'static' 端点名:</p>
<div class="hlcode"><pre><span class="n">url_for</span><span class="p">(</span><span class="err">&#39;</span><span class="k">static</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="err">&#39;</span><span class="n">style</span><span class="p">.</span><span class="n">css</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>这个文件应该存储在文件系统上的 static/style.css</p>
<h2 id="_4">渲染模板</h2>
<p>render_template()方法可以渲染模板</p>
<blockquote>
<p>在模板内部可以访问 request, sesion, g对象，以及get_flashed_messages()函数</p>
</blockquote>
<p>自动转义默认开启，传入模板的变量包含HTML，将被自动转义，更多特性参考Jinja文档</p>
<blockquote>
<p>自动转义只为扩展名为 .html, .htm, .xml, xhtml 开启，从字符串载入的模板将关闭自动转义</p>
</blockquote>
<h2 id="_5">文件上传</h2>
<p>用 Flask 处理文件上传，须在 HTML 表单中设置 enctype="multipart/form-data" 属性，不然浏览器不会发送文件。</p>
<p>已上传的文件存储在内存或是文件系统中一个临时的位置。你可以通过请求对象的 files 属性访问它们。每个上传的文件都会存储在这个字典里。它表现近乎为一个标准的 Python file 对象，但它还有一个 save() 方法，这个方法允许你把文件保存到服务器的文件系统上。</p>
<p>把文件按客户端提供的文件名存储在服务器上，可以将它传递给 Werkzeug 提供的 secure_filename() 函数，做文件名的过滤。</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/upload&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload_file</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;the_file&#39;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;/var/www/uploads/&#39;</span> <span class="o">+</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
    <span class="o">...</span>
</pre></div>


<blockquote>
<p>save 支持相对路径和绝对路径</p>
</blockquote>
<h2 id="_6">关于响应</h2>
<p>视图函数的返回值会被自动转换为一个响应对象。如果返回值是一个字符串， 它被转换为该字符串为主体的、状态码为 <code>200 OK</code> 的 、 MIME 类型是 <code>text/html</code> 的响应对象。Flask 把返回值转换为响应对象的逻辑是这样：</p>
<ul>
<li>如果返回的是一个合法的响应对象，它会从视图直接返回。</li>
<li>如果返回的是一个字符串，响应对象会用字符串数据和默认参数创建。</li>
<li>如果返回的是一个元组，且元组中的元素可以提供额外的信息。这样的元组必须是 (response, status, headers) 的形式，且至少包含一个元素。 status 值会覆盖状态代码， headers 可以是一个列表或字典，作为额外的消息标头值。</li>
<li>如果上述条件均不满足， Flask 会假设返回值是一个合法的 WSGI 应用程序，并转换为一个请求对象。</li>
</ul>
<p>如果你想在视图里操纵上述步骤结果的响应对象，可以使用 make_response() 函数。如有这样一个视图:</p>
<div class="hlcode"><pre><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">),</span> <span class="mi">404</span>
</pre></div>


<p>只需要把返回值表达式传递给 make_response() ，获取结果对象并修改，然后再返回它:</p>
<div class="hlcode"><pre><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">),</span> <span class="mi">404</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;X-Something&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;A value&#39;</span>
    <span class="k">return</span> <span class="n">resp</span>
</pre></div>


<h2 id="_7">会话</h2>
<p>是在 Cookies 的基础上实现的，并且对 Cookies 进行密钥签名。这意味着用户可以查看你 Cookie 的内容，但却不能修改它，除非用户知道签名的密钥。</p>
<p>要使用会话，需要设置一个密钥</p>
<div class="hlcode"><pre><span class="c"># logout</span>
<span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<h2 id="_8">日志</h2>
<p>Flask 就已经预置了日志系统</p>
<div class="hlcode"><pre><span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;A value for debugging&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;A warning occurred (</span><span class="si">%d</span><span class="s"> apples)&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;An error occurred&#39;</span><span class="p">)</span>
</pre></div>


<h2 id="wsgi">整合 WSGI 中间件¶</h2>
<p>给应用添加 WSGI 中间件，可以封装内部 WSGI 应用。</p>
<p>例如若是想用 Werkzeug 包中的某个中间件来应付 lighttpd 中的 bugs ，可以这样做:</p>
<div class="hlcode"><pre><span class="kn">from</span> <span class="nn">werkzeug.contrib.fixers</span> <span class="kn">import</span> <span class="n">LighttpdCGIRootFix</span>
<span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">LighttpdCGIRootFix</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">)</span>
</pre></div>


<h2 id="sqlite">sqlite</h2>
<h2 id="_9">路径</h2>
<p>app.root_path 属性可以获取应用的路径。配合 os.path 模块使用，轻松可达任意文件</p>
<h2 id="note">note</h2>
<ul>
<li>return a requests response object</li>
</ul>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">index</span><span class="p">()</span><span class="o">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">xxx</span><span class="err">&#39;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="n">resp</span><span class="p">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">resp</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">items</span><span class="p">())</span>
</pre></div>


<ul>
<li>Flask instance</li>
</ul>
<div class="hlcode"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>


<p>app 的属性或方法会比 Flask 多</p>
</div>

        </div>
        <div id="footer">
            <span>
                Copyright © 2012-2016 .
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        
    </body>
</html>